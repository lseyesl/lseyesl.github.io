<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8"utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="https://img.alicdn.com/tfs/TB1YHEpwUT1gK0jSZFhXXaAtVXa-28-27.svg"
    />
    <link rel="stylesheet" href="../umi.css" tppabs="https://umijs.org/umi.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.2.3
    </script>
    <title>&#x670D;&#x52A1;&#x7AEF;&#x6E32;&#x67D3;&#xFF08;SSR&#xFF09;</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" href="../index.htm" tppabs="https://umijs.org/">UmiJS</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a aria-current="page" class="active" href="../docs.htm" tppabs="https://umijs.org/docs">Docs</a><a href="../config.htm" tppabs="https://umijs.org/config">Config</a><a href="../api.htm" tppabs="https://umijs.org/api">API</a><a href="../guide.htm" tppabs="https://umijs.org/guide">Guide</a><a href="../plugins.htm" tppabs="https://umijs.org/plugins">Plugins</a><a target="_blank" href="javascript:if(confirm('https://v2.umijs.org/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://v2.umijs.org/'" tppabs="https://v2.umijs.org/">v2.x<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a target="_blank" href="javascript:if(confirm('https://github.com/umijs/umi  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://github.com/umijs/umi'" tppabs="https://github.com/umijs/umi">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><div class="__dumi-default-locale-select" data-locale-count="2"><span>中文</span></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" href="../index.htm" tppabs="https://umijs.org/"></a><h1>UmiJS</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a aria-current="page" class="active" href="../docs.htm" tppabs="https://umijs.org/docs">Docs</a></li><li><a href="../config.htm" tppabs="https://umijs.org/config">Config</a></li><li><a href="../api.htm" tppabs="https://umijs.org/api">API</a></li><li><a href="../guide.htm" tppabs="https://umijs.org/guide">Guide</a></li><li><a href="../plugins.htm" tppabs="https://umijs.org/plugins">Plugins</a></li><li><a target="_blank" href="javascript:if(confirm('https://v2.umijs.org/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://v2.umijs.org/'" tppabs="https://v2.umijs.org/">v2.x<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" href="javascript:if(confirm('https://github.com/umijs/umi  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://github.com/umijs/umi'" tppabs="https://github.com/umijs/umi">GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-locale-select" data-locale-count="2"><span>中文</span></div></div><ul class="__dumi-default-menu-list"><li><a>VERSION 3.X</a></li><li><a>Introduce</a><ul><li><a href="../docs.htm" tppabs="https://umijs.org/docs"><span>Introduce</span></a></li><li><a href="how-umi-works.htm" tppabs="https://umijs.org/docs/how-umi-works"><span>How Umi Works</span></a></li><li><a href="getting-started.htm" tppabs="https://umijs.org/docs/getting-started"><span>Getting Started</span></a></li></ul></li><li><a>Umi Basic</a><ul><li><a href="directory-structure.htm" tppabs="https://umijs.org/docs/directory-structure"><span>Directory structure</span></a></li><li><a href="config.htm" tppabs="https://umijs.org/docs/config"><span>Config</span></a></li><li><a href="runtime-config.htm" tppabs="https://umijs.org/docs/runtime-config"><span>Runtime Config</span></a></li><li><a href="routing.htm" tppabs="https://umijs.org/docs/routing"><span>Routing</span></a></li><li><a href="convention-routing.htm" tppabs="https://umijs.org/docs/convention-routing"><span>Convention Routing</span></a></li><li><a href="plugin.htm" tppabs="https://umijs.org/docs/plugin"><span>Plugin</span></a></li><li><a href="navigate-between-pages.htm" tppabs="https://umijs.org/docs/navigate-between-pages"><span>Navigate Between Pages</span></a></li><li><a href="html-template.htm" tppabs="https://umijs.org/docs/html-template"><span>HTML Template</span></a></li><li><a href="mock.htm" tppabs="https://umijs.org/docs/mock"><span>Mock Data</span></a></li><li><a href="env-variables.htm" tppabs="https://umijs.org/docs/env-variables"><span>Env Variables</span></a></li><li><a href="cli.htm" tppabs="https://umijs.org/docs/cli"><span>Cli Commands</span></a></li></ul></li><li><a>Styles and Assets</a><ul><li><a href="assets-css.htm" tppabs="https://umijs.org/docs/assets-css"><span>Use CSS</span></a></li><li><a href="assets-image.htm" tppabs="https://umijs.org/docs/assets-image"><span>Use Image</span></a></li></ul></li><li><a>Umi Advanced</a><ul><li><a href="load-on-demand.htm" tppabs="https://umijs.org/docs/load-on-demand"><span>Load On Demand</span></a></li><li><a href="deployment.htm" tppabs="https://umijs.org/docs/deployment"><span>Deployment</span></a></li><li><a href="use-umi-ui.htm" tppabs="https://umijs.org/docs/use-umi-ui"><span>Using Umi UI</span></a></li><li><a aria-current="page" class="active" href="ssr.htm" tppabs="https://umijs.org/docs/ssr"><span>服务端渲染（SSR）</span></a></li></ul></li><li><a href="upgrade-to-umi-3.htm" tppabs="https://umijs.org/docs/upgrade-to-umi-3">Upgrade to Umi 3</a></li><li><a href="contributing.htm" tppabs="https://umijs.org/docs/contributing">CONTRIBUTING</a></li><li><a href="faq.htm" tppabs="https://umijs.org/docs/faq">FAQ</a></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="什么是服务端渲染？" data-depth="2" class=""><a href="ssr.htm#什么是服务端渲染？" tppabs="https://umijs.org/docs/ssr#什么是服务端渲染？"><span>什么是服务端渲染？</span></a></li><li title="什么是预渲染？" data-depth="2" class=""><a href="ssr.htm#什么是预渲染？" tppabs="https://umijs.org/docs/ssr#什么是预渲染？"><span>什么是预渲染？</span></a></li><li title="Umi 服务端渲染特性" data-depth="2" class=""><a href="ssr.htm#umi-服务端渲染特性" tppabs="https://umijs.org/docs/ssr#umi-服务端渲染特性"><span>Umi 服务端渲染特性</span></a></li><li title="启用服务端渲染" data-depth="2" class=""><a href="ssr.htm#启用服务端渲染" tppabs="https://umijs.org/docs/ssr#启用服务端渲染"><span>启用服务端渲染</span></a></li><li title="开发" data-depth="2" class=""><a href="ssr.htm#开发" tppabs="https://umijs.org/docs/ssr#开发"><span>开发</span></a></li><li title="数据预获取" data-depth="2" class=""><a href="ssr.htm#数据预获取" tppabs="https://umijs.org/docs/ssr#数据预获取"><span>数据预获取</span></a></li><li title="页面级数据获取" data-depth="3" class=""><a href="ssr.htm#页面级数据获取" tppabs="https://umijs.org/docs/ssr#页面级数据获取"><span>页面级数据获取</span></a></li><li title="使用" data-depth="3" class=""><a href="ssr.htm#使用" tppabs="https://umijs.org/docs/ssr#使用"><span>使用</span></a></li><li title="扩展 ctx 参数" data-depth="3" class=""><a href="ssr.htm#扩展-ctx-参数" tppabs="https://umijs.org/docs/ssr#扩展-ctx-参数"><span>扩展 ctx 参数</span></a></li><li title="部署" data-depth="2" class=""><a href="ssr.htm#部署" tppabs="https://umijs.org/docs/ssr#部署"><span>部署</span></a></li><li title="polyfill" data-depth="2" class=""><a href="ssr.htm#polyfill" tppabs="https://umijs.org/docs/ssr#polyfill"><span>polyfill</span></a></li><li title="动态加载（dynamicImport）" data-depth="2" class=""><a href="ssr.htm#动态加载（dynamicimport）" tppabs="https://umijs.org/docs/ssr#动态加载（dynamicimport）"><span>动态加载（dynamicImport）</span></a></li><li title="使用流式渲染（Streaming）" data-depth="2" class=""><a href="ssr.htm#使用流式渲染（streaming）" tppabs="https://umijs.org/docs/ssr#使用流式渲染（streaming）"><span>使用流式渲染（Streaming）</span></a></li><li title="使用预渲染" data-depth="2" class=""><a href="ssr.htm#使用预渲染" tppabs="https://umijs.org/docs/ssr#使用预渲染"><span>使用预渲染</span></a></li><li title="开启预渲染" data-depth="3" class=""><a href="ssr.htm#开启预渲染" tppabs="https://umijs.org/docs/ssr#开启预渲染"><span>开启预渲染</span></a></li><li title="预渲染动态路由" data-depth="3" class=""><a href="ssr.htm#预渲染动态路由" tppabs="https://umijs.org/docs/ssr#预渲染动态路由"><span>预渲染动态路由</span></a></li><li title="页面标题渲染" data-depth="2" class=""><a href="ssr.htm#页面标题渲染" tppabs="https://umijs.org/docs/ssr#页面标题渲染"><span>页面标题渲染</span></a></li><li title="在 dumi 中使用" data-depth="2" class=""><a href="ssr.htm#在-dumi-中使用" tppabs="https://umijs.org/docs/ssr#在-dumi-中使用"><span>在 dumi 中使用</span></a></li><li title="数据流结合" data-depth="2" class=""><a href="ssr.htm#数据流结合" tppabs="https://umijs.org/docs/ssr#数据流结合"><span>数据流结合</span></a></li><li title="与 dva 结合使用" data-depth="3" class=""><a href="ssr.htm#与-dva-结合使用" tppabs="https://umijs.org/docs/ssr#与-dva-结合使用"><span>与 dva 结合使用</span></a></li><li title="包大小分析" data-depth="2" class=""><a href="ssr.htm#包大小分析" tppabs="https://umijs.org/docs/ssr#包大小分析"><span>包大小分析</span></a></li><li title="FAQ" data-depth="2" class=""><a href="ssr.htm#faq" tppabs="https://umijs.org/docs/ssr#faq"><span>FAQ</span></a></li><li title="window is not defined, document is not defined, navigator is not defined" data-depth="3" class=""><a href="ssr.htm#window-is-not-defined-document-is-not-defined-navigator-is-not-defined" tppabs="https://umijs.org/docs/ssr#window-is-not-defined-document-is-not-defined-navigator-is-not-defined"><span>window is not defined, document is not defined, navigator is not defined</span></a></li><li title="antd pro 怎样使用服务端渲染？" data-depth="3" class=""><a href="ssr.htm#antd-pro-怎样使用服务端渲染？" tppabs="https://umijs.org/docs/ssr#antd-pro-怎样使用服务端渲染？"><span>antd pro 怎样使用服务端渲染？</span></a></li><li title="为什么不能 external 服务端中的一些模块" data-depth="3" class=""><a href="ssr.htm#为什么不能-external-服务端中的一些模块" tppabs="https://umijs.org/docs/ssr#为什么不能-external-服务端中的一些模块"><span>为什么不能 external 服务端中的一些模块</span></a></li><li title="Prop dangerouslySetInnerHTML did not match. 报错" data-depth="3" class=""><a href="ssr.htm#prop-dangerouslysetinnerhtml-did-not-match-报错" tppabs="https://umijs.org/docs/ssr#prop-dangerouslysetinnerhtml-did-not-match-报错"><span>Prop dangerouslySetInnerHTML did not match. 报错</span></a></li><li title="如何判断当前页面是 SSR 还是 CSR？" data-depth="3" class=""><a href="ssr.htm#如何判断当前页面是-ssr-还是-csr？" tppabs="https://umijs.org/docs/ssr#如何判断当前页面是-ssr-还是-csr？"><span>如何判断当前页面是 SSR 还是 CSR？</span></a></li></ul><div class="__dumi-default-layout-content"><div class="__dumi-default-alert">This article has not been translated yet. Want to help us out? Click the Edit this doc on GitHub at the end of the page.</div><div class="markdown"><h1 id="服务端渲染（ssr）"><a aria-hidden="true" href="#服务端渲染（ssr）"><span class="icon icon-link"></span></a>服务端渲染（SSR）</h1><h2 id="什么是服务端渲染？"><a aria-hidden="true" href="#什么是服务端渲染？"><span class="icon icon-link"></span></a>什么是服务端渲染？</h2><blockquote><p>首先我们先了解下，以及是否符合我们的业务场景，再决定是否需要使用。</p></blockquote><p>服务端渲染（Server-Side Rendering），是指由<strong>服务侧</strong>完成页面的 HTML 结构拼接的页面处理技术，发送到浏览器，然后为其绑定状态与事件，成为完全可交互页面的过程。</p><p>这么讲可能比较学术，那通过两张图来更容易地说清楚。</p><p>第一张，单页应用（SPA）和服务端渲染过的（SSR）站点在<strong>社交分享</strong>时的区别：</p><img style="box-shadow:rgba(0, 0, 0, 0.15) 0px 3px 6px 0px" src="../../user-images.githubusercontent.com/13595509/68102160-5e66da00-ff0c-11e9-82e8-7c73cca1b20f.png" tppabs="https://user-images.githubusercontent.com/13595509/68102160-5e66da00-ff0c-11e9-82e8-7c73cca1b20f.png" width="600"/><p>第二张，<strong>白屏时间</strong>上 SSR 较少，因为当 HTML 文档返回时，已经有对应的内容。（见 Network）</p><img style="box-shadow:rgba(0, 0, 0, 0.15) 0px 3px 6px 0px" src="../../user-images.githubusercontent.com/13595509/80308316-e74a3880-8800-11ea-9a20-2d9d153fe9d1.png" tppabs="https://user-images.githubusercontent.com/13595509/80308316-e74a3880-8800-11ea-9a20-2d9d153fe9d1.png"/><p>综上两图可知，SSR 常用于以下两个场景：</p><ol><li>有 <strong>SEO 诉求</strong>，用在搜索引擎检索以及社交分享，用在前台类应用。</li><li><strong>首屏渲染</strong>时长有要求，常用在移动端、弱网情况下。</li></ol><blockquote><p>也就是说，如果你是中后台应用（如 antd pro、管理后台等），请谨慎考虑是否使用 SSR。</p></blockquote><h2 id="什么是预渲染？"><a aria-hidden="true" href="#什么是预渲染？"><span class="icon icon-link"></span></a>什么是预渲染？</h2><p>服务端渲染，首先得有后端服务器（一般是 Node.js）才可以使用，如果我没有后端服务器，也想用在上面提到的两个场景，那么推荐使用<strong>预渲染</strong>。</p><p>预渲染与服务端渲染唯一的不同点在于<strong>渲染时机</strong>，服务端渲染的时机是在用户访问时执行渲染（即<strong>实时渲染</strong>，数据一般是最新的），预渲染的时机是在项目构建时，当用户访问时，数据不是一定是最新的（如果数据没有实时性，则可以直接考虑预渲染）。</p><p>预渲染（Pre Render）在构建时执行渲染，将渲染后的 HTML 片段生成静态 HTML 文件。无需使用 web 服务器实时动态编译 HTML，适用于<strong>静态站点生成</strong>。</p><h2 id="umi-服务端渲染特性"><a aria-hidden="true" href="#umi-服务端渲染特性"><span class="icon icon-link"></span></a>Umi 服务端渲染特性</h2><blockquote><p>早在 Umi 2.8+ 版本时，Umi 已具备 SSR 能力，只是使用上对新手而言，门槛较高。</p></blockquote><p>Umi 3 结合自身业务场景，在 SSR 上做了大量优化及开发体验的提升，具有以下特性：</p><ul><li><strong>开箱即用</strong>：内置 SSR，一键开启，<code>umi dev</code> 即 SSR 预览，开发调试方便。</li><li><strong>服务端框架无关</strong>：Umi 不耦合服务端框架（例如 <a href="javascript:if(confirm('https://eggjs.org/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://eggjs.org/'" tppabs="https://eggjs.org/" target="_blank">Egg.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="javascript:if(confirm('https://expressjs.com/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://expressjs.com/'" tppabs="https://expressjs.com/" target="_blank">Express<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="javascript:if(confirm('https://koajs.com/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://koajs.com/'" tppabs="https://koajs.com/" target="_blank">Koa<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），无论是哪种框架或者 Serverless 模式，都可以非常简单进行集成。</li><li><strong>支持应用和页面级数据预获取</strong>：Umi 3 中延续了 Umi 2 中的页面数据预获取（getInitialProps），来解决之前全局数据的获取问题。</li><li><strong>支持按需加载</strong>：按需加载 <code>dynamicImport</code> 开启后，Umi 3 中会根据不同路由加载对应的资源文件（css/js）。</li><li><strong>内置预渲染功能</strong>：Umi 3 中内置了预渲染功能，不再通过安装额外插件使用，同时开启 <code>ssr</code> 和 <code>exportStatic</code>，在 <code>umi build</code> 构建时会编译出渲染后的 HTML。</li><li><strong>支持渲染降级</strong>：优先使用 SSR，如果服务端渲染失败，自动降级为客户端渲染（CSR），不影响正常业务流程。</li><li><strong>支持流式渲染</strong>：<code>ssr: <!-- -->{<!-- --> mode: &#x27;stream&#x27; <!-- -->}</code> 即可开启流式渲染，流式 SSR 较正常 SSR 有更少的 <a href="javascript:if(confirm('https://baike.baidu.com/item/TTFB  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://baike.baidu.com/item/TTFB'" tppabs="https://baike.baidu.com/item/TTFB" target="_blank">TTFB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（发出页面请求到接收到应答数据第一个字节所花费的毫秒数） 时间。</li><li><strong>兼容客户端动态加载</strong>：在 Umi 2 中同时使用 SSR 和 dynamicImport（动态加载）会有一些问题，在 Umi 3 中可同时开启使用。</li><li><strong>SSR 功能插件化</strong>：Umi 3 内置的 SSR 功能基本够用，若不满足需求或者想自定义渲染方法，可通过提供的 API 来自定义。</li></ul><h2 id="启用服务端渲染"><a aria-hidden="true" href="#启用服务端渲染"><span class="icon icon-link"></span></a>启用服务端渲染</h2><p>默认情况下，服务端渲染功能是关闭的，你需要在使用之前通过配置开启：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="export default {
  ssr: {},
}
" data-status="copy"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="开发"><a aria-hidden="true" href="#开发"><span class="icon icon-link"></span></a>开发</h2><p>执行 <code>umi dev</code>，访问页面，即是服务端渲染后的。</p><img style="box-shadow:rgba(0, 0, 0, 0.15) 0px 3px 6px 0px" src="../../user-images.githubusercontent.com/13595509/80309380-4743dd80-8807-11ea-9def-7bb43522dce3.png" tppabs="https://user-images.githubusercontent.com/13595509/80309380-4743dd80-8807-11ea-9def-7bb43522dce3.png" width="600"/><blockquote><p><a href="#%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E6%98%AF-ssr-%E8%BF%98%E6%98%AF-csr%EF%BC%9F">如何判断当前页面是 SSR 还是 CSR？</a></p></blockquote><p>如果与后端框架在开发模式下一起使用时，可通过配置来关闭 <code>umi dev</code> 下的服务端渲染行为：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="
export default {
  ssr: {
    // 默认为 true
    devServerRender: false,
  },
}
" data-status="copy"></button><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 默认为 true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    devServerRender</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="数据预获取"><a aria-hidden="true" href="#数据预获取"><span class="icon icon-link"></span></a>数据预获取</h2><p>服务端渲染的数据获取方式与 SPA（单页应用）有所不同，为了让客户端和服务端都能获取到同一份数据，我们提供了 页面级数据 预获取。</p><h3 id="页面级数据获取"><a aria-hidden="true" href="#页面级数据获取"><span class="icon icon-link"></span></a>页面级数据获取</h3><h3 id="使用"><a aria-hidden="true" href="#使用"><span class="icon icon-link"></span></a>使用</h3><p>每个页面可能有单独的数据预获取逻辑，这里我们会获取页面组件上的 <code>getInitialProps</code> 静态方法，执行后将结果注入到该页面组件的 <code>props</code> 中，例如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-tsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// pages/index.tsx
import { IGetInitialProps } from &#x27;umi&#x27;;
import React from &#x27;react&#x27;;

const Home = (props) =&gt; {
  const { data } = props;
  return (
    {/* &lt;div&gt;Hello World&lt;/div&gt; */}
    &lt;div&gt;{data.title}&lt;/div&gt;
  )
}

Home.getInitialProps = (async (ctx) =&gt; {
  return Promise.resolve({
    data: {
      title: &#x27;Hello World&#x27;,
    }
  })
}) as IGetInitialProps;

/** 同时也可以使用 class 组件
class Home extends React.Component {
  static getInitialProps = (async (ctx) =&gt; {
    return Promise.resolve({
      data: {
        title: &#x27;Hello World&#x27;,
      }
    })
  }) as IGetInitialProps
  render() {
    const { data } = props;
    return (
      &lt;div&gt;{data.title}&lt;/div&gt;
    )
  }
}
*/

export default Home;
" data-status="copy"></button><div class="token-line"><span class="token comment">// pages/index.tsx</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">IGetInitialProps</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;umi&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Home</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> data </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> props</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">{</span><span class="token comment">/* &lt;div&gt;Hello World&lt;/div&gt; */</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">data</span><span class="token punctuation">.</span><span class="token plain">title</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">Home</span><span class="token punctuation">.</span><span class="token plain">getInitialProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    data</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      title</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;Hello World&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">as</span><span class="token plain"> </span><span class="token maybe-class-name">IGetInitialProps</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">/** 同时也可以使用 class 组件</span></div><div class="token-line"><span class="token comment">class Home extends React.Component {</span></div><div class="token-line"><span class="token comment">  static getInitialProps = (async (ctx) =&gt; {</span></div><div class="token-line"><span class="token comment">    return Promise.resolve({</span></div><div class="token-line"><span class="token comment">      data: {</span></div><div class="token-line"><span class="token comment">        title: &#x27;Hello World&#x27;,</span></div><div class="token-line"><span class="token comment">      }</span></div><div class="token-line"><span class="token comment">    })</span></div><div class="token-line"><span class="token comment">  }) as IGetInitialProps</span></div><div class="token-line"><span class="token comment">  render() {</span></div><div class="token-line"><span class="token comment">    const { data } = props;</span></div><div class="token-line"><span class="token comment">    return (</span></div><div class="token-line"><span class="token comment">      &lt;div&gt;{data.title}&lt;/div&gt;</span></div><div class="token-line"><span class="token comment">    )</span></div><div class="token-line"><span class="token comment">  }</span></div><div class="token-line"><span class="token comment">}</span></div><div class="token-line"><span class="token comment">*/</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token maybe-class-name">Home</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>getInitialProps</code> 中有几个固定参数：</p><ul><li><code>match</code>： 与客户端页面 props 中的 <code>match</code> 保持一致，有当前路由的相关数据。</li><li><code>isServer</code>：是否为服务端在执行该方法。</li><li><code>route</code>：当前路由对象</li><li><code>history</code>：history 对象</li></ul><h3 id="扩展-ctx-参数"><a aria-hidden="true" href="#扩展-ctx-参数"><span class="icon icon-link"></span></a>扩展 ctx 参数</h3><p>为了结合数据流框架，我们提供了 <code>modifyGetInitialPropsCtx</code> 方法，由插件或应用来扩展 <code>ctx</code> 参数，以 <code>dva</code> 为例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// plugin-dva/runtime.ts
export const ssr = {
  modifyGetInitialPropsCtx: async (ctx) =&gt; {
    ctx.store = getApp()._store;
  },
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// plugin-dva/runtime.ts</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> ssr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">modifyGetInitialPropsCtx</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ctx</span><span class="token punctuation">.</span><span class="token property-access">store</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">_store</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>然后在页面中，可以通过获取到 <code>store</code>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-tsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// pages/index.tsx
const Home = () =&gt; &lt;div /&gt;;

Home.getInitialProps = async (ctx) =&gt; {
  const state = ctx.store.getState();
  return state;
}

export default Home;
" data-status="copy"></button><div class="token-line"><span class="token comment">// pages/index.tsx</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function maybe-class-name">Home</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">Home</span><span class="token punctuation">.</span><span class="token function-variable function">getInitialProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> state </span><span class="token operator">=</span><span class="token plain"> ctx</span><span class="token punctuation">.</span><span class="token plain">store</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> state</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token maybe-class-name">Home</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>同时也可以在自身应用中进行扩展：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// app.(ts|js)
export const ssr = {
  modifyGetInitialPropsCtx: async (ctx) =&gt; {
    ctx.title = &#x27;params&#x27;;
    return ctx;
  }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// app.(ts|js)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> ssr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">modifyGetInitialPropsCtx</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ctx</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;params&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> ctx</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>同时可以使用 <code>getInitialPropsCtx</code> 将服务端参数扩展到 <code>ctx</code> 中，例如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="app.use(async (req, res) =&gt; {
  // 或者从 CDN 上下载到 server 端
  // const serverPath = await downloadServerBundle(&#x27;http://cdn.com/bar/umi.server.js&#x27;);
  const render = require(&#x27;./dist/umi.server&#x27;);
  res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/html&#x27;);

  const context = {};
  const { html, error, rootContainer } = await render({
    // 有需要可带上 query
    path: req.url,
    context,
    getInitialPropsCtx: {
      req,
    },
  });
})
" data-status="copy"></button><div class="token-line"><span class="token plain">app</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 或者从 CDN 上下载到 server 端</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// const serverPath = await downloadServerBundle(&#x27;http://cdn.com/bar/umi.server.js&#x27;);</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> render </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./dist/umi.server&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;text/html&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> html</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">,</span><span class="token plain"> rootContainer </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 有需要可带上 query</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    path</span><span class="token punctuation">:</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    context</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    getInitialPropsCtx</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      req</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在使用的时候，就有 <code>req</code> 对象，不过需要注意的是，只在服务端执行时才有此参数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Page.getInitialProps = async (ctx) =&gt; {
  if (ctx.isServer) {
    // console.log(ctx.req);
  }
  return {};
}
" data-status="copy"></button><div class="token-line"><span class="token maybe-class-name">Page</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">getInitialProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ctx</span><span class="token punctuation">.</span><span class="token property-access">isServer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// console.log(ctx.req);</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>则在执行 <code>getInitialProps</code> 方法时，除了以上两个固定参数外，还会获取到 <code>title</code> 和 <code>store</code> 参数。</p><p>关于 <code>getInitialProps</code> 执行逻辑和时机，这里需要注意：</p><ul><li>开启 ssr，且执行成功<ul><li>未开启 <code>forceInitial</code>，首屏不触发 <code>getInitialProps</code>，切换页面时会执行请求，和客户端渲染逻辑保持一致。</li><li>开启 <code>forceInitial</code>，无论是首屏还是页面切换，都会触发 <code>getInitialProps</code>，目的是始终以客户端请求的数据为准。（有用在静态页面站点的实时数据请求上）</li></ul></li><li>未开启 ssr 时，只要页面组件中有 <code>getInitialProps</code> 静态方法，则会执行该方法。</li></ul><h2 id="部署"><a aria-hidden="true" href="#部署"><span class="icon icon-link"></span></a>部署</h2><p>执行 <code>umi build</code> ，除了正常的 <code>umi.js</code> 外，会多一个服务端文件： <code>umi.server.js</code> （相当于服务端入口文件，类比浏览器加载 umi.js 客户端渲染）</p><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="- dist
  - umi.js
  - umi.css
  - index.html
+ - umi.server.js
" data-status="copy"></button><div class="token-line"><span class="token deleted-sign deleted">- dist</span></div><div class="token-line"><span class="token deleted-sign deleted"></span><span class="token unchanged">  - umi.js</span></div><div class="token-line"><span class="token unchanged">  - umi.css</span></div><div class="token-line"><span class="token unchanged">  - index.html</span></div><div class="token-line"><span class="token unchanged"></span><span class="token inserted-sign inserted">+ - umi.server.js</span></div><div class="token-line"><span class="token inserted-sign inserted"></span></div></pre></div><p>然后在后端框架中，引用该文件：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// Express
app.use(async (req, res) =&gt; {
  // 或者从 CDN 上下载到 server 端
  // const serverPath = await downloadServerBundle(&#x27;http://cdn.com/bar/umi.server.js&#x27;);
  const render = require(&#x27;./dist/umi.server&#x27;);
  res.setHeader(&#x27;Content-Type&#x27;, &#x27;text/html&#x27;);

  const context = {};
  const { html, error, rootContainer } = await render({
    // 有需要可带上 query
    path: req.url,
    context,

    // 可自定义 html 模板
    // htmlTemplate: defaultHtml,

    // 启用流式渲染
    // mode: &#x27;stream&#x27;,

    // html 片段静态标记（适用于静态站点生成）
    // staticMarkup: false,

    // 扩展 getInitialProps 在服务端渲染中的参数
    // getInitialPropsCtx: {},

    // manifest，正常情况下不需要
  });

  // support stream content
  if (content instanceof Stream) {
    html.pipe(res);
    html.on(&#x27;end&#x27;, function() {
      res.end();
    });
  } else {
    res.send(res);
  }
})
" data-status="copy"></button><div class="token-line"><span class="token comment">// Express</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">app</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 或者从 CDN 上下载到 server 端</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// const serverPath = await downloadServerBundle(&#x27;http://cdn.com/bar/umi.server.js&#x27;);</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> render </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./dist/umi.server&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;text/html&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> html</span><span class="token punctuation">,</span><span class="token plain"> error</span><span class="token punctuation">,</span><span class="token plain"> rootContainer </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 有需要可带上 query</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    path</span><span class="token punctuation">:</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    context</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 可自定义 html 模板</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// htmlTemplate: defaultHtml,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 启用流式渲染</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// mode: &#x27;stream&#x27;,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// html 片段静态标记（适用于静态站点生成）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// staticMarkup: false,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 扩展 getInitialProps 在服务端渲染中的参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// getInitialPropsCtx: {},</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// manifest，正常情况下不需要</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// support stream content</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">content </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Stream</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    html</span><span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    html</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;end&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    res</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>render</code> 方法参数和返回值如下：</p><p>参数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="{
  // 渲染页面路由，支持 `base` 和带 query 的路由，通过 umi 配置
  path: string;
  // 可选，初始化数据，传透传到 getInitialProps 方法的参数中
  initialData?: object;
  // 可选，html 模板，这里可自定义模板，默认是用 umi 内置的 html
  htmlTemplate?: string;
  // 可选，页面内容挂载节点，与 htmlTemplate 配合使用，默认为 root
  mountElementId?: string;
  // 上下文数据，可用来标记服务端渲染页面时的状态
  context?: object
  // ${protocol}://${host} 扩展 location 对象
  origin?: string;
}
" data-status="copy"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 渲染页面路由，支持 `base` 和带 query 的路由，通过 umi 配置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  path</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 可选，初始化数据，传透传到 getInitialProps 方法的参数中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  initialData</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> object</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 可选，html 模板，这里可自定义模板，默认是用 umi 内置的 html</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  htmlTemplate</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 可选，页面内容挂载节点，与 htmlTemplate 配合使用，默认为 root</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  mountElementId</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 上下文数据，可用来标记服务端渲染页面时的状态</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  context</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> object</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ${protocol}://${host} 扩展 location 对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  origin</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>返回值：</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="{
  // html 内容，服务端渲染错误后，会返回原始 html
  html?: string | Stream;
  // 挂载节点中的渲染内容（ssr 渲染实际上只是渲染挂载节点中的内容），同时你也可以用该值来拼接自定义模板
  rootContainer: string | Stream;
  // 错误对象，服务端渲染错误后，值不为 null
  error?: Error;
}
" data-status="copy"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// html 内容，服务端渲染错误后，会返回原始 html</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  html</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Stream</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 挂载节点中的渲染内容（ssr 渲染实际上只是渲染挂载节点中的内容），同时你也可以用该值来拼接自定义模板</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  rootContainer</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Stream</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 错误对象，服务端渲染错误后，值不为 null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  error</span><span class="token operator">?</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Error</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="polyfill"><a aria-hidden="true" href="#polyfill"><span class="icon icon-link"></span></a>polyfill</h2><p>Umi 3 默认移除了 DOM/BOM 浏览器 API 在 Node.js 的 polyfill，如果应用确实需要 polyfill 一些浏览器对象，可以使用 <code>beforeRenderServer</code> 运行时事件 API 进行扩展</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// app.ts
export const ssr = {
  beforeRenderServer: async ({
    env,
    location,
    history,
    mode,
    context,
  }) =&gt; {
    // global 为 Node.js 下的全局变量
    // 避免直接 mock location，这样会造成一些环境判断失效
    global.mockLocation = location;

    // 国际化
    if (location.pathname.indexOf(&#x27;zh-CN&#x27;) &gt; -1) {
      global.locale = &#x27;zh-CN&#x27;
    }
  }
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// app.ts</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> ssr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function-variable function">beforeRenderServer</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter punctuation">{</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    env</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    location</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    history</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    mode</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">    context</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// global 为 Node.js 下的全局变量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 避免直接 mock location，这样会造成一些环境判断失效</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    global</span><span class="token punctuation">.</span><span class="token property-access">mockLocation</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">location</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 国际化</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token dom variable">location</span><span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token string">&#x27;zh-CN&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      global</span><span class="token punctuation">.</span><span class="token property-access">locale</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;zh-CN&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="动态加载（dynamicimport）"><a aria-hidden="true" href="#动态加载（dynamicimport）"><span class="icon icon-link"></span></a>动态加载（dynamicImport）</h2><p>完美兼容客户端动态加载，配置如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-ts"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// .umirc.ts
export default {
  ssr: {},
  dynamicImport: {},
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// .umirc.ts</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  dynamicImport</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>使用动态加载后，启动和构建会自动开启 <a href="../zh-CN/config.htm#manifest" tppabs="https://umijs.org/zh-CN/config#manifest">manifest</a> 配置，并在产物目录中生成 <code>asset-manifest.json</code> 做资源映射，并自动将页面对应的资源注入到 HTML 中，避免开启动态加载后，<strong>页面首屏闪烁</strong>的问题。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="- dist
  - umi.server.js
  - asset-manifest.json
" data-status="copy"></button><div class="token-line"><span class="token plain">- dist</span></div><div class="token-line"><span class="token plain">  - umi.server.js</span></div><div class="token-line"><span class="token plain">  - asset-manifest.json</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>则页面返回的 HTML 将增加对应 chunk（资源）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="
&lt;html&gt;
  &lt;head&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;/umi.css&quot; /&gt;
+   &lt;link rel=&quot;stylesheet&quot; href=&quot;/p__index.chunk.css&quot; /&gt;
  &lt;/head&gt;
&lt;/html&gt;
" data-status="copy"></button><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token deleted-arrow deleted">&lt;html&gt;</span></div><div class="token-line"><span class="token deleted-arrow deleted"></span><span class="token unchanged">  &lt;head&gt;</span></div><div class="token-line"><span class="token unchanged">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/umi.css&quot; /&gt;</span></div><div class="token-line"><span class="token unchanged"></span><span class="token inserted-sign inserted">+   &lt;link rel=&quot;stylesheet&quot; href=&quot;/p__index.chunk.css&quot; /&gt;</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token unchanged">  &lt;/head&gt;</span></div><div class="token-line"><span class="token unchanged"></span><span class="token deleted-arrow deleted">&lt;/html&gt;</span></div><div class="token-line"><span class="token deleted-arrow deleted"></span></div></pre></div><h2 id="使用流式渲染（streaming）"><a aria-hidden="true" href="#使用流式渲染（streaming）"><span class="icon icon-link"></span></a>使用流式渲染（Streaming）</h2><p>提供开箱即用的流式渲染功能，开启方式：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="export default {
  ssr: {
    mode: &#x27;stream&#x27;,
  },
}
" data-status="copy"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    mode</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;stream&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="使用预渲染"><a aria-hidden="true" href="#使用预渲染"><span class="icon icon-link"></span></a>使用预渲染</h2><h3 id="开启预渲染"><a aria-hidden="true" href="#开启预渲染"><span class="icon icon-link"></span></a>开启预渲染</h3><p>通过 <code>exportStatic</code> 结合 <code>ssr</code> 开启预渲染</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="export default {
  ssr: {},
  exportStatic: {},
}
" data-status="copy"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  exportStatic</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>执行 <code>umi build</code>，会将输出渲染后的 HTML</p><img style="box-shadow:rgba(0, 0, 0, 0.15) 0px 3px 6px 0px" src="../../user-images.githubusercontent.com/13595509/80445233-53828480-8946-11ea-8884-016b88c14220.png" tppabs="https://user-images.githubusercontent.com/13595509/80445233-53828480-8946-11ea-8884-016b88c14220.png"/><h3 id="预渲染动态路由"><a aria-hidden="true" href="#预渲染动态路由"><span class="icon icon-link"></span></a>预渲染动态路由</h3><p>预渲染默认情况下不会渲染动态路由里的所有页面，如果需要渲染动态路由中的页面，通过配置 <code>extraRoutePaths</code>，例如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="export default {
  ssr: {},
  exportStatic: {
+   extraRoutePaths: async () =&gt; {
+     // const result = await request(&#x27;https://your-api/news/list&#x27;);
+     return Promise.resolve([&#x27;/news/1&#x27;, &#x27;news/2&#x27;]);
+   }
  },
  routes: [
    {
      path: &#x27;/&#x27;,
      component: &#x27;@/layout&#x27;,
      routes: [
        { path: &#x27;/&#x27;, component: &#x27;@/pages/index&#x27; },
        { path: &#x27;/news&#x27;, component: &#x27;@/pages/news&#x27; },
        { path: &#x27;/news/:id&#x27;, component: &#x27;@/pages/news/detail&#x27; }
      ]
    }
  ]
}
" data-status="copy"></button><div class="token-line"><span class="token plain">export default {</span></div><div class="token-line"><span class="token plain"></span><span class="token unchanged">  ssr: {},</span></div><div class="token-line"><span class="token unchanged">  exportStatic: {</span></div><div class="token-line"><span class="token unchanged"></span><span class="token inserted-sign inserted">+   extraRoutePaths: async () =&gt; {</span></div><div class="token-line"><span class="token inserted-sign inserted">+     // const result = await request(&#x27;https://your-api/news/list&#x27;);</span></div><div class="token-line"><span class="token inserted-sign inserted">+     return Promise.resolve([&#x27;/news/1&#x27;, &#x27;news/2&#x27;]);</span></div><div class="token-line"><span class="token inserted-sign inserted">+   }</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token unchanged">  },</span></div><div class="token-line"><span class="token unchanged">  routes: [</span></div><div class="token-line"><span class="token unchanged">    {</span></div><div class="token-line"><span class="token unchanged">      path: &#x27;/&#x27;,</span></div><div class="token-line"><span class="token unchanged">      component: &#x27;@/layout&#x27;,</span></div><div class="token-line"><span class="token unchanged">      routes: [</span></div><div class="token-line"><span class="token unchanged">        { path: &#x27;/&#x27;, component: &#x27;@/pages/index&#x27; },</span></div><div class="token-line"><span class="token unchanged">        { path: &#x27;/news&#x27;, component: &#x27;@/pages/news&#x27; },</span></div><div class="token-line"><span class="token unchanged">        { path: &#x27;/news/:id&#x27;, component: &#x27;@/pages/news/detail&#x27; }</span></div><div class="token-line"><span class="token unchanged">      ]</span></div><div class="token-line"><span class="token unchanged">    }</span></div><div class="token-line"><span class="token unchanged">  ]</span></div><div class="token-line"><span class="token unchanged"></span><span class="token plain">}</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>则会生成以下产物：</p><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text=" - dist
   - umi.js
   - umi.css
   - index.html
   - news
    - :id
      - index.html
+   - 1
+     - index.html
+   - 2
+     - index.html
    - index.html
" data-status="copy"></button><div class="token-line"><span class="token unchanged"> - dist</span></div><div class="token-line"><span class="token unchanged">   - umi.js</span></div><div class="token-line"><span class="token unchanged">   - umi.css</span></div><div class="token-line"><span class="token unchanged">   - index.html</span></div><div class="token-line"><span class="token unchanged">   - news</span></div><div class="token-line"><span class="token unchanged">    - :id</span></div><div class="token-line"><span class="token unchanged">      - index.html</span></div><div class="token-line"><span class="token unchanged"></span><span class="token inserted-sign inserted">+   - 1</span></div><div class="token-line"><span class="token inserted-sign inserted">+     - index.html</span></div><div class="token-line"><span class="token inserted-sign inserted">+   - 2</span></div><div class="token-line"><span class="token inserted-sign inserted">+     - index.html</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token unchanged">    - index.html</span></div><div class="token-line"><span class="token unchanged"></span></div></pre></div><blockquote><p>默认情况下，预渲染后会删除 <code>umi.server.js</code> 服务端入口文件，如果需要保留，可使用变量 <code>RM_SERVER_FILE=none</code> 来保留 <code>umi.server.js</code>。</p></blockquote><h2 id="页面标题渲染"><a aria-hidden="true" href="#页面标题渲染"><span class="icon icon-link"></span></a>页面标题渲染</h2><p><a href="../zh-CN/plugins/preset-react.htm#umijspreset-react" tppabs="https://umijs.org/zh-CN/plugins/preset-react#umijspreset-react">@umijs/preset-react</a> 插件集中已内置对标题的渲染，通过以下步骤使用：</p><p>安装：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ yarn add @umijs/preset-react
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">yarn</span><span class="token plain"> </span><span class="token function">add</span><span class="token plain"> @umijs/preset-react</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>在页面中，即直接可以渲染标题：</p><div class="__dumi-default-code-block"><pre class="prism-code language-tsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// pages/bar.tsx
import React from &#x27;react&#x27;;
import { Helmet } from &#x27;umi&#x27;;

export default props =&gt; {
  return (
    &lt;&gt;
      {/* 可自定义需不需要编码 */}
      &lt;Helmet encodeSpecialCharacters={false}&gt;
        &lt;html lang=&quot;en&quot; data-direction=&quot;666&quot; /&gt;
        &lt;title&gt;Hello Umi Bar Title&lt;/title&gt;
      &lt;/Helmet&gt;
    &lt;/&gt;
  );
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// pages/bar.tsx</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">Helmet</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;umi&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token parameter">props</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token comment">/* 可自定义需不需要编码 */</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Helmet</span><span class="token tag"> </span><span class="token tag attr-name">encodeSpecialCharacters</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript boolean">false</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token tag punctuation">&lt;</span><span class="token tag">html</span><span class="token tag"> </span><span class="token tag attr-name">lang</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">en</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag attr-name">data-direction</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">666</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token tag punctuation">&lt;</span><span class="token tag">title</span><span class="token tag punctuation">&gt;</span><span class="token maybe-class-name">Hello</span><span class="token plain"> </span><span class="token maybe-class-name">Umi</span><span class="token plain"> </span><span class="token maybe-class-name">Bar</span><span class="token plain"> </span><span class="token maybe-class-name">Title</span><span class="token tag punctuation">&lt;/</span><span class="token tag">title</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token tag punctuation">&lt;/</span><span class="token tag class-name">Helmet</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><img src="../../user-images.githubusercontent.com/13595509/80379292-770ae800-88d0-11ea-8f6e-4585cc1970ac.png" tppabs="https://user-images.githubusercontent.com/13595509/80379292-770ae800-88d0-11ea-8f6e-4585cc1970ac.png" alt="image"/></p><h2 id="在-dumi-中使用"><a aria-hidden="true" href="#在-dumi-中使用"><span class="icon icon-link"></span></a>在 dumi 中使用</h2><p><a href="javascript:if(confirm('https://d.umijs.org/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://d.umijs.org/'" tppabs="https://d.umijs.org/" target="_blank">dumi<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：基于 Umi、为组件开发场景而生的文档工具，Umi 官网文档即使用 dumi 编写并结合预渲染，让文档内容具备 SEO，可使用源代码查看，开启方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-jsx"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="export default {
  ssr: {},
  exportStatic: {},
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  exportStatic</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><img src="../../user-images.githubusercontent.com/13595509/80310631-52e6d280-880e-11ea-9a9a-0942c0e24658.png" tppabs="https://user-images.githubusercontent.com/13595509/80310631-52e6d280-880e-11ea-9a9a-0942c0e24658.png" width="600" style="box-shadow:rgba(0, 0, 0, 0.15) 0px 3px 6px 0px"/><h2 id="数据流结合"><a aria-hidden="true" href="#数据流结合"><span class="icon icon-link"></span></a>数据流结合</h2><h3 id="与-dva-结合使用"><a aria-hidden="true" href="#与-dva-结合使用"><span class="icon icon-link"></span></a>与 dva 结合使用</h3><p><a href="../zh-CN/plugins/preset-react.htm#umijspreset-react" tppabs="https://umijs.org/zh-CN/plugins/preset-react#umijspreset-react">@umijs/preset-react</a> 插件集中已内置 dva，通过以下步骤使用：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="$ yarn add @umijs/preset-react
" data-status="copy"></button><div class="token-line"><span class="token plain">$ </span><span class="token function">yarn</span><span class="token plain"> </span><span class="token function">add</span><span class="token plain"> @umijs/preset-react</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>开启 dva，并在 <code>models</code> 目录下创建 dva model：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="export default {
  ssr: {},
  dva: {}
}
" data-status="copy"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  ssr</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  dva</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这时候 <code>getInitialProps(ctx)</code> 中的 <code>ctx</code> 就会有 <code>store</code> 属性，可执行 <code>dispatch</code>，并返回初始化数据。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Page.getInitialProps = async (ctx) =&gt; {
  const { store } = ctx;
  store.dispatch({
    type: &#x27;bar/getData&#x27;,
  });
  return store.getState();
}
" data-status="copy"></button><div class="token-line"><span class="token maybe-class-name">Page</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">getInitialProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> store </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> ctx</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  store</span><span class="token punctuation">.</span><span class="token method function property-access">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;bar/getData&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> store</span><span class="token punctuation">.</span><span class="token method function property-access">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="包大小分析"><a aria-hidden="true" href="#包大小分析"><span class="icon icon-link"></span></a>包大小分析</h2><p>Umi 同时支持对服务端和客户端包大小的分析</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="# 服务端包大小分析
$ ANALYZE_SSR=1 umi build
# 客户端包大小分析
$ ANALYZE=1 umi build
" data-status="copy"></button><div class="token-line"><span class="token comment"># 服务端包大小分析</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token assign-left variable">ANALYZE_SSR</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain"> umi build</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 客户端包大小分析</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ </span><span class="token assign-left variable">ANALYZE</span><span class="token operator">=</span><span class="token number">1</span><span class="token plain"> umi build</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><img width="600" style="box-shadow:rgba(0, 0, 0, 0.15) 0px 3px 6px 0px" src="../../user-images.githubusercontent.com/13595509/80446129-8b8ac700-8948-11ea-82a8-54d94501a672.png" tppabs="https://user-images.githubusercontent.com/13595509/80446129-8b8ac700-8948-11ea-82a8-54d94501a672.png"/><h2 id="faq"><a aria-hidden="true" href="#faq"><span class="icon icon-link"></span></a>FAQ</h2><h3 id="window-is-not-defined-document-is-not-defined-navigator-is-not-defined"><a aria-hidden="true" href="#window-is-not-defined-document-is-not-defined-navigator-is-not-defined"><span class="icon icon-link"></span></a>window is not defined, document is not defined, navigator is not defined</h3><p>SSR 因为会在服务端执行 render 渲染方法，而服务端没有 DOM/BOM 变量和方法，为解决这类问题，提供以下几个方法：</p><ol><li>如果是项目自身的代码，建议将访问的 DOM/BOM 方法放在 <code>componentDidMount</code>、<code>useEffect</code> 中（服务端不会执行），避免服务端执行时报错，例如：</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import React from &#x27;react&#x27;;

export default () =&gt; {
- window.alert(1);
  React.useEffect(() =&gt; {
+   window.alert(1);
  }, []);

  return (
    &lt;div&gt;Hello&lt;/div&gt;
  )
}
" data-status="copy"></button><div class="token-line"><span class="token plain">import React from &#x27;react&#x27;;</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">export default () =&gt; {</span></div><div class="token-line"><span class="token plain"></span><span class="token deleted-sign deleted">- window.alert(1);</span></div><div class="token-line"><span class="token deleted-sign deleted"></span><span class="token unchanged">  React.useEffect(() =&gt; {</span></div><div class="token-line"><span class="token unchanged"></span><span class="token inserted-sign inserted">+   window.alert(1);</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token unchanged">  }, []);</span></div><div class="token-line"><span class="token unchanged"></span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token unchanged">  return (</span></div><div class="token-line"><span class="token unchanged">    &lt;div&gt;Hello&lt;/div&gt;</span></div><div class="token-line"><span class="token unchanged">  )</span></div><div class="token-line"><span class="token unchanged"></span><span class="token plain">}</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="2"><li>通过 umi 提供的 <code>isBrowser</code> 方法做环境判断，例如：</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="import React from &#x27;react&#x27;;
+ import { isBrowser } from &#x27;umi&#x27;;

export default () =&gt; {
- window.alert(1);
+ if (!isBrowser()) {
    window.alert(1);
+ }

  return (
    &lt;div&gt;Hello&lt;/div&gt;
  )
}
" data-status="copy"></button><div class="token-line"><span class="token plain">import React from &#x27;react&#x27;;</span></div><div class="token-line"><span class="token plain"></span><span class="token inserted-sign inserted">+ import { isBrowser } from &#x27;umi&#x27;;</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token plain"></span></div><div class="token-line"><span class="token plain">export default () =&gt; {</span></div><div class="token-line"><span class="token plain"></span><span class="token deleted-sign deleted">- window.alert(1);</span></div><div class="token-line"><span class="token deleted-sign deleted"></span><span class="token inserted-sign inserted">+ if (!isBrowser()) {</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token unchanged">    window.alert(1);</span></div><div class="token-line"><span class="token unchanged"></span><span class="token inserted-sign inserted">+ }</span></div><div class="token-line"><span class="token inserted-sign inserted"></span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token unchanged">  return (</span></div><div class="token-line"><span class="token unchanged">    &lt;div&gt;Hello&lt;/div&gt;</span></div><div class="token-line"><span class="token unchanged">  )</span></div><div class="token-line"><span class="token unchanged"></span><span class="token plain">}</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="antd-pro-怎样使用服务端渲染？"><a aria-hidden="true" href="#antd-pro-怎样使用服务端渲染？"><span class="icon icon-link"></span></a>antd pro 怎样使用服务端渲染？</h3><p>首先，<a href="javascript:if(confirm('https://github.com/ant-design/ant-design-pro/  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://github.com/ant-design/ant-design-pro/'" tppabs="https://github.com/ant-design/ant-design-pro/" target="_blank">antd pro<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 作为中后台项目,没有 SEO 需求，不适合做服务端渲染； 从技术角度来讲，antd pro 在 render 里大量使用 DOM/BOM 方法，服务端渲染将 DOM/BOM 操作改至副作用（<code>useEffect</code> 或 <code>componentDidMount</code> 周期中），可以给 antd pro 提 PR。</p><h3 id="为什么不能-external-服务端中的一些模块"><a aria-hidden="true" href="#为什么不能-external-服务端中的一些模块"><span class="icon icon-link"></span></a>为什么不能 external 服务端中的一些模块</h3><ol><li>因为 umi 内部模块大量使用了 <code>alias</code>，如果做 external 会做大量模块的路径映射，真正在服务端使用时，会出现某些包路径不对，加载不了的报错</li><li>有些模块需要依赖模块实例才会做服务端渲染（例如 <a href="javascript:if(confirm('https://github.com/nfl/react-helmet  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://github.com/nfl/react-helmet'" tppabs="https://github.com/nfl/react-helmet" target="_blank">react-helmet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）为了保持同一实例，不会使用 external</li><li>经过测试，服务端包 external 后与不 external，在 <a href="javascript:if(confirm('https://baike.baidu.com/item/TTFB  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://baike.baidu.com/item/TTFB'" tppabs="https://baike.baidu.com/item/TTFB" target="_blank">TTFB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（发出页面请求到接收到应答数据第一个字节所花费的毫秒数）没有明显区别</li></ol><p>综合考虑，Umi 3 SSR 不会对服务端文件（<code>umi.server.js</code>）做 external。</p><h3 id="prop-dangerouslysetinnerhtml-did-not-match-报错"><a aria-hidden="true" href="#prop-dangerouslysetinnerhtml-did-not-match-报错"><span class="icon icon-link"></span></a><code>Prop </code>dangerouslySetInnerHTML<code> did not match.</code> 报错</h3><p>只有 <code>div</code> 标签 <code>dangerouslySetInnerHTML</code> 属性才能被 SSR 渲染，正常的写法应该是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-diff"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="- &lt;p dangerouslySetInnerHTML={{ __html: &#x27;&lt;p&gt;Hello&lt;/p&gt;&#x27; }} /&gt;
+ &lt;div dangerouslySetInnerHTML={{ __html: &#x27;&lt;p&gt;Hello&lt;/p&gt;&#x27; }} /&gt;
" data-status="copy"></button><div class="token-line"><span class="token deleted-sign deleted">- &lt;p dangerouslySetInnerHTML={{ __html: &#x27;&lt;p&gt;Hello&lt;/p&gt;&#x27; }} /&gt;</span></div><div class="token-line"><span class="token deleted-sign deleted"></span><span class="token inserted-sign inserted">+ &lt;div dangerouslySetInnerHTML={{ __html: &#x27;&lt;p&gt;Hello&lt;/p&gt;&#x27; }} /&gt;</span></div><div class="token-line"><span class="token inserted-sign inserted"></span></div></pre></div><h3 id="如何判断当前页面是-ssr-还是-csr？"><a aria-hidden="true" href="#如何判断当前页面是-ssr-还是-csr？"><span class="icon icon-link"></span></a>如何判断当前页面是 SSR 还是 CSR？</h3><p>查看网页源代码，如果 <code>&lt;div id=&quot;root&quot;&gt;</code> DOM 里的元素不为空，则是 SSR，否则为 CSR。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" href="javascript:if(confirm('https://github.com/umijs/umi/edit/master/docs/docs/ssr.md  \n\nļ޷ Teleport Ultra , Ϊ һ·ⲿΪʼַĵַ  \n\nڷϴ?'))window.location='https://github.com/umijs/umi/edit/master/docs/docs/ssr.md'" tppabs="https://github.com/umijs/umi/edit/master/docs/docs/ssr.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">6/10/2020, 7:42:23 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "../../www.google-analytics.com/analytics.js"/*tpa=https://www.google-analytics.com/analytics.js*/,
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="../umi.js" tppabs="https://umijs.org/umi.js"></script>
  </body>
</html>
