<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset=utf-8"utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dva æºç è§£æ | DvaJS</title>
    <meta name="description" content="React and redux based, lightweight and elm-style framework.">
    
    
    <link rel="preload" href="/assets/css/0.styles.56052c7b.css" as="style"><link rel="preload" href="/assets/js/app.0350af5f.js" as="script"><link rel="preload" href="/assets/js/15.d6e76d28.js" as="script"><link rel="prefetch" href="/assets/js/10.c92e8561.js"><link rel="prefetch" href="/assets/js/11.bf005912.js"><link rel="prefetch" href="/assets/js/12.ac9cbdcf.js"><link rel="prefetch" href="/assets/js/13.630bf05d.js"><link rel="prefetch" href="/assets/js/14.660b7dd5.js"><link rel="prefetch" href="/assets/js/16.190e2547.js"><link rel="prefetch" href="/assets/js/17.1bf4a649.js"><link rel="prefetch" href="/assets/js/2.b37273cf.js"><link rel="prefetch" href="/assets/js/3.f73926c2.js"><link rel="prefetch" href="/assets/js/4.25c1c6c7.js"><link rel="prefetch" href="/assets/js/5.bacd05e6.js"><link rel="prefetch" href="/assets/js/6.35edbabf.js"><link rel="prefetch" href="/assets/js/7.19a2461b.js"><link rel="prefetch" href="/assets/js/8.3fbf0504.js"><link rel="prefetch" href="/assets/js/9.2c969215.js">
    <link rel="stylesheet" href="../assets/css/0.styles.56052c7b.css" tppabs="https://dvajs.com/assets/css/0.styles.56052c7b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="../index.htm" tppabs="https://dvajs.com/" class="home-link router-link-active"><!----> <span class="site-name">DvaJS</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="index.htm" tppabs="https://dvajs.com/guide/" class="nav-link router-link-active">æŒ‡å—</a></div><div class="nav-item"><a href="../api/index.htm" tppabs="https://dvajs.com/api/" class="nav-link">API</a></div><div class="nav-item"><a href="../knowledgemap/index.htm" tppabs="https://dvajs.com/knowledgemap/" class="nav-link">çŸ¥è¯†åœ°å›¾</a></div><div class="nav-item"><a href="javascript:if(confirm('https://github.com/dvajs/dva/releases  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/releases'" tppabs="https://github.com/dvajs/dva/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  å‘å¸ƒæ—¥å¿—
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="javascript:if(confirm('https://github.com/dvajs/dva  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva'" tppabs="https://github.com/dvajs/dva" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="index.htm" tppabs="https://dvajs.com/guide/" class="nav-link router-link-active">æŒ‡å—</a></div><div class="nav-item"><a href="../api/index.htm" tppabs="https://dvajs.com/api/" class="nav-link">API</a></div><div class="nav-item"><a href="../knowledgemap/index.htm" tppabs="https://dvajs.com/knowledgemap/" class="nav-link">çŸ¥è¯†åœ°å›¾</a></div><div class="nav-item"><a href="javascript:if(confirm('https://github.com/dvajs/dva/releases  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/releases'" tppabs="https://github.com/dvajs/dva/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  å‘å¸ƒæ—¥å¿—
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="javascript:if(confirm('https://github.com/dvajs/dva  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva'" tppabs="https://github.com/dvajs/dva" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>æŒ‡å—</span> <!----></p> <ul class="sidebar-group-items"><li><a href="index.htm" tppabs="https://dvajs.com/guide/" class="sidebar-link">ä»‹ç»</a></li><li><a href="getting-started.html" tppabs="https://dvajs.com/guide/getting-started.html" class="sidebar-link">å¿«é€Ÿä¸Šæ‰‹</a></li><li><a href="examples-and-boilerplates.html" tppabs="https://dvajs.com/guide/examples-and-boilerplates.html" class="sidebar-link">ä¾‹å­å’Œè„šæ‰‹æ¶</a></li><li><a href="concepts.html" tppabs="https://dvajs.com/guide/concepts.html" class="sidebar-link">Dva æ¦‚å¿µ</a></li><li><a href="introduce-class.html" tppabs="https://dvajs.com/guide/introduce-class.html" class="sidebar-link">å…¥é—¨è¯¾</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>ç¤¾åŒº</span> <!----></p> <ul class="sidebar-group-items"><li><a href="fig-show.html" tppabs="https://dvajs.com/guide/fig-show.html" class="sidebar-link">Dva å›¾è§£</a></li><li><a href="develop-complex-spa.html" tppabs="https://dvajs.com/guide/develop-complex-spa.html" class="sidebar-link">ä½¿ç”¨ Dva å¼€å‘å¤æ‚ SPA</a></li><li><a href="source-code-explore.html" tppabs="https://dvajs.com/guide/source-code-explore.html" class="active sidebar-link">Dva æºç è§£æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="source-code-explore.html#éšè—åœ¨-package-json-é‡Œçš„ç§˜å¯†" tppabs="https://dvajs.com/guide/source-code-explore.html#éšè—åœ¨-package-json-é‡Œçš„ç§˜å¯†" class="sidebar-link">éšè—åœ¨ package.json é‡Œçš„ç§˜å¯†</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#src-index-js" tppabs="https://dvajs.com/guide/source-code-explore.html#src-index-js" class="sidebar-link">src/index.js</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#å¯»æ‰¾-â€œdvaâ€" tppabs="https://dvajs.com/guide/source-code-explore.html#å¯»æ‰¾-â€œdvaâ€" class="sidebar-link">å¯»æ‰¾ â€œdvaâ€</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#src-index-js-2" tppabs="https://dvajs.com/guide/source-code-explore.html#src-index-js-2" class="sidebar-link">src/index.js</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#è§†å›¾ä¸æ•°æ®-ä¸Š" tppabs="https://dvajs.com/guide/source-code-explore.html#è§†å›¾ä¸æ•°æ®-ä¸Š" class="sidebar-link">è§†å›¾ä¸æ•°æ®(ä¸Š)</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#è§†å›¾ä¸æ•°æ®-ä¸‹" tppabs="https://dvajs.com/guide/source-code-explore.html#è§†å›¾ä¸æ•°æ®-ä¸‹" class="sidebar-link">è§†å›¾ä¸æ•°æ®(ä¸‹)</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#package-json" tppabs="https://dvajs.com/guide/source-code-explore.html#package-json" class="sidebar-link">package.json</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#src-index-js-3" tppabs="https://dvajs.com/guide/source-code-explore.html#src-index-js-3" class="sidebar-link">src/index.js</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#model-æ–¹æ³•" tppabs="https://dvajs.com/guide/source-code-explore.html#model-æ–¹æ³•" class="sidebar-link">model æ–¹æ³•</a></li><li class="sidebar-sub-header"><a href="source-code-explore.html#start-æ–¹æ³•" tppabs="https://dvajs.com/guide/source-code-explore.html#start-æ–¹æ³•" class="sidebar-link">start æ–¹æ³•</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="dva-æºç è§£æ"><a href="#dva-æºç è§£æ" aria-hidden="true" class="header-anchor">#</a> Dva æºç è§£æ</h1> <blockquote><p>ä½œè€…ï¼šæ¨å…‰</p></blockquote> <h2 id="éšè—åœ¨-package-json-é‡Œçš„ç§˜å¯†"><a href="#éšè—åœ¨-package-json-é‡Œçš„ç§˜å¯†" aria-hidden="true" class="header-anchor">#</a> éšè—åœ¨ package.json é‡Œçš„ç§˜å¯†</h2> <p>éšä¾¿å“ªä¸ª dva çš„é¡¹ç›®ï¼Œåªè¦æ•²å…¥ npm start å°±å¯ä»¥è¿è¡Œå¯åŠ¨ã€‚ä¹‹å‰æ•²äº†æ— æ•°æ¬¡æˆ‘éƒ½æ²¡æœ‰åœ¨æ„ï¼Œç›´åˆ°æˆ‘å‡†å¤‡ç ”ç©¶æºç çš„æ—¶å€™æ‰æ„è¯†åˆ°ï¼š<strong>åœ¨æ•²ä¸‹è¿™è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p> <p>ç­”æ¡ˆè¦å» package.json é‡Œå»å¯»æ‰¾ã€‚</p> <blockquote><p>æœ‰ä½æŠ€æœ¯å¤§ç‰›æ›¾ç»å‘Šè¯‰è¿‡æˆ‘ï¼šçœ‹æºç ä¹‹å‰ï¼Œå…ˆå»çœ‹ package.json ã€‚çœ‹çœ‹é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼Œç¿»ç¿»å®ƒç”¨äº†å“ªäº›ä¾èµ–ï¼Œå¯¹é¡¹ç›®ä¾¿æœ‰äº†å¤§è‡´çš„æ¦‚å¿µã€‚</p></blockquote> <p>package.json é‡Œæ˜¯è¿™ä¹ˆå†™çš„ï¼š</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;roadhog server&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>ç¿»ç¿»ä¾èµ–ï¼Œ<code>&quot;roadhog&quot;: &quot;^0.5.2&quot;</code>ã€‚</p> <p>æ—¢ç„¶èƒ½åœ¨ devDependencies æ‰¾åˆ°ï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿèƒ½åœ¨ <a href="javascript:if(confirm('https://www.npmjs.com/package/roadhog  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://www.npmjs.com/package/roadhog'" tppabs="https://www.npmjs.com/package/roadhog" target="_blank" rel="noopener noreferrer">npm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ä¸Šæ‰¾åˆ°ã€‚åŸæ¥æ˜¯ä¸ªå’Œ webpack ç›¸ä¼¼çš„åº“ï¼Œè€Œä¸”ä½œè€…çœ‹ç€æœ‰ç‚¹çœ¼ç†Ÿ...</p> <p>å¦‚æœè¯´ dva æ˜¯äº²å¥³å„¿ï¼Œé‚£ <a href="javascript:if(confirm('https://github.com/sorrycc/roadhog.git  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/sorrycc/roadhog.git'" tppabs="https://github.com/sorrycc/roadhog.git" target="_blank" rel="noopener noreferrer">roadhog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å°±æ˜¯äº²å“¥å“¥äº†ï¼Œèµ·çš„æ˜¯ webpack è‡ªåŠ¨æ‰“åŒ…å’Œçƒ­æ›´æ›¿çš„ä½œç”¨ã€‚</p> <p>åœ¨ roadhog çš„é»˜è®¤é…ç½®é‡Œæœ‰è¿™ä¹ˆä¸€æ¡ä¿¡æ¯ï¼š</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;entry&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åè½¬äº†ä¸€åœˆï¼Œå¯åŠ¨çš„å…¥å£å›åˆ°äº† <code>src/index.js</code>ã€‚</p> <h2 id="src-index-js"><a href="#src-index-js" aria-hidden="true" class="header-anchor">#</a> <code>src/index.js</code></h2> <p>åœ¨ <code>src/index.js</code> é‡Œï¼Œdva ä¸€å…±åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š</p> <ol start="0"><li><p>ä» 'dva' ä¾èµ–ä¸­å¼•å…¥ dva ï¼š<code>import dva from 'dva'</code>;</p></li> <li><p>é€šè¿‡å‡½æ•°ç”Ÿæˆä¸€ä¸ª app å¯¹è±¡ï¼š<code>const app = dva()</code>;</p></li> <li><p>åŠ è½½æ’ä»¶ï¼š<code>app.use({})</code>;</p></li> <li><p>æ³¨å…¥ modelï¼š<code>app.model(require('./models/example'))</code>;</p></li> <li><p>æ·»åŠ è·¯ç”±ï¼š<code>app.router(require('./routes/indexAnother'))</code>;</p></li> <li><p>å¯åŠ¨ï¼šapp.start('#root');</p></li></ol> <p>åœ¨è¿™ 6 æ­¥å½“ä¸­ï¼Œdva å®Œæˆäº† <code>ä½¿ç”¨ React è§£å†³ view å±‚</code>ã€<code>redux ç®¡ç† model</code>ã€<code>saga è§£å†³å¼‚æ­¥</code>çš„ä¸»è¦åŠŸèƒ½ã€‚äº‹å®ä¸Šåœ¨æˆ‘æŸ¥é˜…èµ„æ–™ä»¥åŠå›å¿†ç”¨è¿‡çš„è„šæ‰‹æ¶æ—¶ï¼Œå‘ç°ç›®å‰ç«¯æ¡†æ¶ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºâ€œæ¡†æ¶â€ä¹Ÿå°±æ˜¯è§£å†³äº†è¿™äº›äº‹æƒ…ã€‚å‰ç«¯å·¥ç¨‹å¸ˆè‡³ä»Šæ‰€åšçš„äº‹æƒ…éƒ½æ˜¯åœ¨ <strong>åˆ†ç¦»åŠ¨æ€çš„ data å’Œé™æ€çš„ view</strong> ï¼Œåªä¸è¿‡ä¾§é‡ç‚¹å’Œå®ç°æ–¹å¼ä¹Ÿä¸åŒã€‚</p> <p>è‡³ä»Šä¸ºæ­¢å‡ºäº†è¿™ä¹ˆå¤šæ¡†æ¶ï¼Œä½†æ˜¯å‰ç«¯ MVX çš„æ€æƒ³ä¸€ç›´éƒ½æ²¡æœ‰æ”¹å˜ã€‚</p> <h1 id="dva"><a href="#dva" aria-hidden="true" class="header-anchor">#</a> dva</h1> <h2 id="å¯»æ‰¾-â€œdvaâ€"><a href="#å¯»æ‰¾-â€œdvaâ€" aria-hidden="true" class="header-anchor">#</a> å¯»æ‰¾ â€œdvaâ€</h2> <p>æ—¢ç„¶ dva æ˜¯æ¥è‡ªäº <code>dva</code>ï¼Œé‚£ä¹ˆ dva æ˜¯ä»€ä¹ˆè¿™ä¸ªé—®é¢˜è‡ªç„¶è¦å» dva çš„<a href="javascript:if(confirm('https://github.com/dvajs/dva  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva'" tppabs="https://github.com/dvajs/dva" target="_blank" rel="noopener noreferrer">æºç <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ä¸­å¯»æ‰¾äº†ã€‚</p> <blockquote><p>å‰§é€ï¼šdva æ˜¯ä¸ªå‡½æ•°ï¼Œè¿”å›ä¸€äº†ä¸ª app çš„å¯¹è±¡ã€‚</p></blockquote> <blockquote><p>å‰§é€2ï¼šç›®å‰ dva çš„æºç æ ¸å¿ƒéƒ¨åˆ†åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œ<code>dva</code> å’Œ <code>dva-core</code>ã€‚å‰è€…ç”¨é«˜é˜¶ç»„ä»¶ React-redux å®ç°äº† view å±‚ï¼Œåè€…æ˜¯ç”¨ redux-saga è§£å†³äº† model å±‚ã€‚</p></blockquote> <p>è€è§„çŸ©ï¼Œè¿˜æ˜¯å…ˆç¿» package.json ã€‚</p> <p>å¼•ç”¨ä¾èµ–å¾ˆå¥½çš„è¯´æ˜äº† dva çš„åŠŸèƒ½ï¼šç»Ÿä¸€ view å±‚ã€‚</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// dva ä½¿ç”¨çš„ä¾èµ–å¦‚ä¸‹ï¼š</span>

    <span class="token property">&quot;babel-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ä¸€ä¸ªç¼–è¯‘åæ–‡ä»¶å¼•ç”¨çš„å…¬å…±åº“ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ç¼–è¯‘åçš„æ–‡ä»¶ä½“ç§¯</span>
    <span class="token property">&quot;dva-core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// dva å¦ä¸€ä¸ªæ ¸å¿ƒï¼Œç”¨äºå¤„ç†æ•°æ®å±‚</span>
    <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.3.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ç”¨äºæä¾›å…¨å±€å‡½æ•°çš„å¼•ç”¨</span>
    <span class="token property">&quot;history&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.6.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// browserHistory æˆ–è€… hashHistory</span>
    <span class="token property">&quot;invariant&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ä¸€ä¸ªæœ‰è¶£çš„æ–­è¨€åº“</span>
    <span class="token property">&quot;isomorphic-fetch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// æ–¹ä¾¿è¯·æ±‚å¼‚æ­¥çš„å‡½æ•°ï¼Œdva ä¸­çš„ fetch æ¥æº</span>
    <span class="token property">&quot;react-async-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.0-beta.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ç»„ä»¶æ‡’åŠ è½½</span>
    <span class="token property">&quot;react-redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.5&quot;</span><span class="token punctuation">,</span> <span class="token comment">// æä¾›äº†ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œæ–¹ä¾¿åœ¨å„å¤„è°ƒç”¨ store</span>
    <span class="token property">&quot;react-router-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// router4ï¼Œç»ˆäºå¯ä»¥åƒå†™ç»„ä»¶ä¸€æ ·å†™ router äº†</span>
    <span class="token property">&quot;react-router-redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.0.0-alpha.6&quot;</span><span class="token punctuation">,</span><span class="token comment">// redux çš„ä¸­é—´ä»¶ï¼Œåœ¨ provider é‡Œå¯ä»¥åµŒå¥— router</span>
    <span class="token property">&quot;redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.7.2&quot;</span> <span class="token comment">// æä¾›äº† storeã€dispatchã€reducer </span>
	
</code></pre></div><p>ä¸è¿‡ script æ²¡æœ‰ç»™å¤ªå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå› ä¸º <code>ruban build</code> ä¸­çš„ <code>ruban</code> æ˜¾ç„¶æ˜¯ä¸ªç§äººåº“(è™½ç„¶åœ¨ tnpm ä¸Šå¯ä»¥æŸ¥åˆ°ä½†æ˜¯ä¹Ÿæ˜¯ç§äººåº“)ã€‚ä½†æ ¹æ®æƒ¯ä¾‹ï¼Œåº”è¯¥æ˜¯ dva åŒ…ä¸‹çš„ <code>index.js</code> æ–‡ä»¶æä¾›äº†å¯¹å¤–è°ƒç”¨ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>connect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-redux'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">;</span>
</code></pre></div><p>æ˜¾ç„¶è¿™ä¸ª <code>exports.default</code> å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ dvaï¼Œä½†æ˜¯æºç ä¸­æ²¡æœ‰ <code>./lib</code> æ–‡ä»¶å¤¹ã€‚å½“ç„¶ç›´æ¥çœ‹ä¹Ÿåº”è¯¥çœ‹ä¸æ‡‚ï¼Œå› ä¸ºä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ babel çš„å‘½ä»¤ <code>babel src -d libs</code> è¿›è¡Œç¼–è¯‘åç”Ÿæˆçš„ï¼Œæ‰€ä»¥ç›´æ¥å»çœ‹ <code>src/index.js</code> æ–‡ä»¶ã€‚</p> <h2 id="src-index-js-2"><a href="#src-index-js-2" aria-hidden="true" class="header-anchor">#</a> <code>src/index.js</code></h2> <p><code>src/index.js</code><a href="javascript:if(confirm('https://github.com/dvajs/dva/blob/master/packages/dva/src/index.js  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/blob/master/packages/dva/src/index.js'" tppabs="https://github.com/dvajs/dva/blob/master/packages/dva/src/index.js" target="_blank" rel="noopener noreferrer">åœ¨æ­¤<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ï¼š</p> <p>åœ¨è¿™é‡Œï¼Œdva åšäº†ä¸‰ä»¶æ¯”è¾ƒé‡è¦çš„äº‹æƒ…ï¼š</p> <ol><li>ä½¿ç”¨ call ç»™ dva-core å®ä¾‹åŒ–çš„ app(è¿™ä¸ªæ—¶å€™è¿˜åªæœ‰æ•°æ®å±‚) çš„ start æ–¹æ³•å¢åŠ äº†ä¸€äº›æ–°åŠŸèƒ½ï¼ˆæˆ–è€…è¯´ï¼Œé€šè¿‡ä»£ç†æ¨¡å¼ç»™ model å±‚å¢åŠ äº† view å±‚ï¼‰ã€‚</li> <li>ä½¿ç”¨ react-redux å®Œæˆäº† react åˆ° redux çš„è¿æ¥ã€‚</li> <li>æ·»åŠ äº† redux çš„ä¸­é—´ä»¶ react-redux-routerï¼Œå¼ºåŒ–äº† history å¯¹è±¡çš„åŠŸèƒ½ã€‚</li></ol> <h3 id="ä½¿ç”¨-call-æ–¹æ³•å®ç°ä»£ç†æ¨¡å¼"><a href="#ä½¿ç”¨-call-æ–¹æ³•å®ç°ä»£ç†æ¨¡å¼" aria-hidden="true" class="header-anchor">#</a> ä½¿ç”¨ call æ–¹æ³•å®ç°ä»£ç†æ¨¡å¼</h3> <p>dva ä¸­å®ç°ä»£ç†æ¨¡å¼çš„æ–¹å¼å¦‚ä¸‹ï¼š</p> <p><strong>1. æ–°å»º function ï¼Œå‡½æ•°å†…å®ä¾‹åŒ–ä¸€ä¸ª app å¯¹è±¡ã€‚</strong> <strong>2. æ–°å»ºå˜é‡æŒ‡å‘è¯¥å¯¹è±¡å¸Œæœ›ä»£ç†çš„æ–¹æ³•ï¼Œ <code>oldStart = app.start</code>ã€‚</strong> <strong>3. æ–°å»ºåŒåæ–¹æ³• startï¼Œåœ¨å…¶ä¸­ä½¿ç”¨ callï¼ŒæŒ‡å®š oldStart çš„è°ƒç”¨è€…ä¸º appã€‚</strong> <strong>4. ä»¤ app.start = startï¼Œå®Œæˆå¯¹ app å¯¹è±¡çš„ start æ–¹æ³•çš„ä»£ç†ã€‚</strong></p> <p>ä¸Šä»£ç :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// ...åˆå§‹åŒ– route ï¼Œå’Œæ·»åŠ  route ä¸­é—´ä»¶çš„æ–¹æ³•ã€‚</span>

  <span class="token comment">/**
   * 1. æ–°å»º function ï¼Œå‡½æ•°å†…å®ä¾‹åŒ–ä¸€ä¸ª app å¯¹è±¡ã€‚
   * 
   */</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> createOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 2. æ–°å»ºå˜é‡æŒ‡å‘è¯¥å¯¹è±¡å¸Œæœ›ä»£ç†çš„æ–¹æ³•
   * 
   */</span>
  <span class="token keyword">const</span> oldAppStart <span class="token operator">=</span> app<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router <span class="token operator">=</span> router<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 4. ä»¤ app.start = startï¼Œå®Œæˆå¯¹ app å¯¹è±¡çš„ start æ–¹æ³•çš„ä»£ç†ã€‚
   * @type {[type]}
   */</span>
  app<span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>

  <span class="token comment">// router èµ‹å€¼</span>

  <span class="token comment">/**
   * 3.1 æ–°å»ºåŒåæ–¹æ³• startï¼Œ
   * 
   */</span>
  <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆæ³•æ€§æ£€æµ‹ä»£ç </span>

    <span class="token comment">/**
     * 3.2 åœ¨å…¶ä¸­ä½¿ç”¨ callï¼ŒæŒ‡å®š oldStart çš„è°ƒç”¨è€…ä¸º appã€‚
     */</span>
    <span class="token function">oldAppStart</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// å› ä¸ºæœ‰ 3.2 çš„æ‰§è¡Œæ‰æœ‰ç°åœ¨çš„ store</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">;</span>

	<span class="token comment">// ä½¿ç”¨é«˜é˜¶ç»„ä»¶åˆ›å»ºè§†å›¾</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ start æ–¹å¼ä¸­ oldAppStart ?</p></blockquote> <ul><li>å› ä¸º dva-core çš„ start æ–¹æ³•é‡Œæœ‰ç”¨åˆ° thisï¼Œä¸ç”¨ call æŒ‡å®šè°ƒç”¨è€…ä¸º app çš„è¯ï¼ŒoldAppStart() ä¼šæ‰¾é”™å¯¹è±¡ã€‚</li></ul> <blockquote><p>å®ç°ä»£ç†æ¨¡å¼ä¸€å®šè¦ç”¨åˆ° call å—ï¼Ÿ</p></blockquote> <ul><li>ä¸ä¸€å®šï¼Œçœ‹æœ‰æ²¡æœ‰ ä½¿ç”¨ this æˆ–è€…ä»£ç†çš„å‡½æ•°æ˜¯ä¸æ˜¯ç®­å¤´å‡½æ•°ã€‚ä»å¦ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œå¦‚æœä½¿ç”¨äº† function å…³é”®å­—åˆåœ¨å†…éƒ¨ä½¿ç”¨äº† thisï¼Œé‚£ä¹ˆä¸€å®šè¦ç”¨ call/apply/bind æŒ‡å®š thisã€‚</li></ul> <blockquote><p>å‰ç«¯è¿˜æœ‰é‚£é‡Œä¼šç”¨åˆ° call ï¼Ÿ</p></blockquote> <ul><li>å°±å®é™…å¼€å‘æ¥è®²ï¼Œå› ä¸ºå·²ç»ä½¿ç”¨äº† es6 æ ‡å‡†ï¼ŒåŸºæœ¬å’Œ this æ²¡ä»€ä¹ˆæ‰“äº¤é“çš„æœºä¼šã€‚ä½¿ç”¨ class ç±»å‹çš„ç»„ä»¶ä¸­å¶å°”è¿˜ä¼šç”¨åˆ° this.xxx.bind(this)ï¼Œstateless ç»„ä»¶å°±æ´—æ´—ç¡å§(å› ä¸ºå‹æ ¹æ²¡æœ‰ this)ã€‚å¦‚æœå®ç°ä»£ç†ï¼Œå¯ä»¥ä½¿ç”¨ç»§æ‰¿/åå‘ç»§æ‰¿çš„æ–¹æ³• â€”â€” æ¯”å¦‚é«˜é˜¶ç»„ä»¶ã€‚</li></ul> <h3 id="ä½¿ç”¨-react-redux-çš„é«˜é˜¶ç»„ä»¶ä¼ é€’-store"><a href="#ä½¿ç”¨-react-redux-çš„é«˜é˜¶ç»„ä»¶ä¼ é€’-store" aria-hidden="true" class="header-anchor">#</a> ä½¿ç”¨ react-redux çš„é«˜é˜¶ç»„ä»¶ä¼ é€’ store</h3> <p>ç»è¿‡ call ä»£ç†åçš„ start æ–¹æ³•çš„ä¸»è¦ä½œç”¨ï¼Œä¾¿æ˜¯ä½¿ç”¨ react-redux çš„ provider ç»„ä»¶å°†æ•°æ®ä¸è§†å›¾è”ç³»äº†èµ·æ¥ï¼Œç”Ÿæˆ React å…ƒç´ å‘ˆç°ç»™ä½¿ç”¨è€…ã€‚</p> <p>ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ä½¿ç”¨ querySelector è·å¾— dom</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    <span class="token template-string"><span class="token string">`[app.start] container </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å…¶ä»–ä»£ç </span>

<span class="token comment">// å®ä¾‹åŒ– store</span>
<span class="token function">oldAppStart</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> store <span class="token operator">=</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">;</span>

<span class="token comment">// export _getProvider for HMR</span>
<span class="token comment">// ref: https://github.com/dvajs/dva/issues/469</span>
app<span class="token punctuation">.</span>_getProvider <span class="token operator">=</span> <span class="token function">getProvider</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// If has container, render; else, return react component</span>
<span class="token comment">// å¦‚æœæœ‰çœŸå®çš„ dom å¯¹è±¡å°±æŠŠ react æ‹è¿›å»</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> app<span class="token punctuation">.</span>_router<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// çƒ­åŠ è½½åœ¨è¿™é‡Œ</span>
  app<span class="token punctuation">.</span><span class="token function">_plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">'onHmr'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦åˆ™å°±ç”Ÿæˆä¸€ä¸ª react ï¼Œä¾›å¤–ç•Œè°ƒç”¨</span>
  <span class="token keyword">return</span> <span class="token function">getProvider</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
 <span class="token comment">// ä½¿ç”¨é«˜é˜¶ç»„ä»¶åŒ…è£¹ç»„ä»¶</span>
<span class="token keyword">function</span> <span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">extraProps</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app<span class="token punctuation">,</span> history<span class="token punctuation">:</span> app<span class="token punctuation">.</span>_history<span class="token punctuation">,</span> <span class="token operator">...</span>extraProps <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// çœŸæ­£çš„ react åœ¨è¿™é‡Œ</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ReactDOM <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-dom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// eslint-disable-line</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token function">getProvider</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>React.createElement(getProvider(store, app, router)) æ€ä¹ˆç†è§£ï¼Ÿ</p></blockquote> <ul><li>getProvider å®é™…ä¸Šè¿”å›çš„ä¸å•çº¯æ˜¯å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„ React ç»„ä»¶ã€‚ä»è¿™ä¸ªè§’åº¦ç†è§£çš„è¯ï¼ŒReactElement.createElement(string/ReactClass type,[object props],[children ...]) æ˜¯å¯ä»¥è¿™ä¹ˆå†™çš„ã€‚</li></ul> <blockquote><p>æ€ä¹ˆç†è§£ React çš„ stateless ç»„ä»¶å’Œ class ç»„ä»¶ï¼Ÿ</p></blockquote> <ul><li>ä½ çŒœçŒœï¼Ÿ</li></ul> <div class="language- extra-class"><pre class="language-text"><code>JavaScript å¹¶ä¸å­˜åœ¨ class è¿™ä¸ªä¸œè¥¿ï¼Œå³ä¾¿æ˜¯ es6 å¼•å…¥äº†ä»¥åç»è¿‡ babel ç¼–è¯‘ä¹Ÿä¼šè½¬æ¢æˆå‡½æ•°ã€‚å› æ­¤ç›´æ¥ä½¿ç”¨æ— çŠ¶æ€ç»„ä»¶ï¼Œçœå»äº†å°† class å®ä¾‹åŒ–å†è°ƒç”¨ render å‡½æ•°çš„è¿‡ç¨‹ï¼Œæœ‰æ•ˆçš„åŠ å¿«äº†æ¸²æŸ“é€Ÿåº¦ã€‚

å³ä¾¿æ˜¯ class ç»„ä»¶ï¼ŒReact.createElement æœ€ç»ˆè°ƒç”¨çš„ä¹Ÿæ˜¯ render å‡½æ•°ã€‚ä¸è¿‡è¿™ä¸ªç›®å‰åªæ˜¯æˆ‘çš„æ¨è®ºï¼Œæ²¡æœ‰ä»£ç è¯æ®çš„è¯æ˜ã€‚
</code></pre></div><h4 id="react-redux-ä¸-provider"><a href="#react-redux-ä¸-provider" aria-hidden="true" class="header-anchor">#</a> react-redux ä¸ provider</h4> <blockquote><p>provider æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ</p></blockquote> <p>æœ¬è´¨ä¸Šæ˜¯ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œä¹Ÿæ˜¯ä»£ç†æ¨¡å¼çš„ä¸€ç§å®è·µæ–¹å¼ã€‚æ¥æ”¶ redux ç”Ÿæˆçš„ store åšå‚æ•°åï¼Œé€šè¿‡ä¸Šä¸‹æ–‡ context å°† store ä¼ é€’è¿›è¢«ä»£ç†ç»„ä»¶ã€‚åœ¨ä¿ç•™åŸç»„ä»¶çš„åŠŸèƒ½ä¸å˜çš„åŒæ—¶ï¼Œå¢åŠ äº† store çš„ dispatch ç­‰æ–¹æ³•ã€‚</p> <blockquote><p>connect æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ</p></blockquote> <p>connect ä¹Ÿæ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼å®ç°çš„é«˜é˜¶ç»„ä»¶ï¼Œä¸ºè¢«ä»£ç†çš„ç»„ä»¶å®ç°äº†ä» context ä¸­è·å¾— store çš„æ–¹æ³•ã€‚</p> <blockquote><p>connect()(MyComponent) æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p></blockquote> <p>åªæ”¾å…³é”®éƒ¨åˆ†ä»£ç ï¼Œå› ä¸ºæˆ‘ä¹Ÿåªçœ‹æ‡‚äº†å…³é”®éƒ¨åˆ†(æ‚è„¸è·‘)ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> connectAdvanced <span class="token keyword">from</span> <span class="token string">'../components/connectAdvanced'</span> 
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createConnect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  connectHOC <span class="token operator">=</span> connectAdvanced<span class="token punctuation">,</span>
<span class="token operator">...</span><span class="token punctuation">.</span> å…¶ä»–åˆå§‹å€¼
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token comment">// 0 å· connnect</span>
    mapStateToProps<span class="token punctuation">,</span>
    mapDispatchToProps<span class="token punctuation">,</span>
   	<span class="token operator">...</span> å…¶ä»–åˆå§‹å€¼
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>å…¶ä»–é€»è¾‘
    <span class="token keyword">return</span> <span class="token function">connectHOC</span><span class="token punctuation">(</span>selectorFactory<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">//  1å· connect</span>
		<span class="token operator">...</span><span class="token punctuation">.</span> é»˜è®¤å‚æ•°
		selectorFactory ä¹Ÿæ˜¯ä¸ªé»˜è®¤å‚æ•°
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è¿™æ˜¯ connect çš„æœ¬ä½“ï¼Œå¯¼å‡ºæ—¶å³ç”Ÿæˆ connect 0</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hoist-non-react-staticsï¼Œä¼šè‡ªåŠ¨æŠŠæ‰€æœ‰ç»‘å®šåœ¨å¯¹è±¡ä¸Šçš„éReactæ–¹æ³•éƒ½ç»‘å®šåˆ°æ–°çš„å¯¹è±¡ä¸Š</span>
<span class="token keyword">import</span> hoistStatics <span class="token keyword">from</span> <span class="token string">'hoist-non-react-statics'</span>
<span class="token comment">// 1å· connect çš„æœ¬ä½“</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">connectAdvanced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// é€»è¾‘å¤„ç†</span>

	<span class="token comment">// 1 å· connect è°ƒç”¨æ—¶ç”Ÿæˆ 2 å· connect</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapWithConnect</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token comment">// ... é€»è¾‘å¤„ç†</span>

	<span class="token comment">// åœ¨å‡½æ•°å†…å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥æ‹¿åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ store çš„ç»„ä»¶</span>
    <span class="token keyword">class</span> <span class="token class-name">Connect</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
      
      <span class="token function">getChildContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­è·å¾— store</span>
        <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propsMode <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscription
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>subscriptionKey<span class="token punctuation">]</span><span class="token punctuation">:</span> subscription <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">[</span>subscriptionKey<span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
		
		<span class="token comment">// é€»è¾‘å¤„ç†</span>

      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		  	<span class="token comment">// 	æœ€ç»ˆç”Ÿæˆäº†æ–°çš„ react å…ƒç´ ï¼Œå¹¶æ·»åŠ äº†æ–°å±æ€§</span>
          <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addExtraProps</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// é€»è¾‘å¤„ç†</span>
	
	<span class="token comment">// æœ€åç”¨å®šä¹‰çš„ class å’Œ è¢«ä»£ç†çš„ç»„ä»¶ç”Ÿæˆæ–°çš„ react ç»„ä»¶</span>
    <span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span>Connect<span class="token punctuation">,</span> WrappedComponent<span class="token punctuation">)</span>  <span class="token comment">// 2 å·å‡½æ•°è°ƒç”¨åç”Ÿæˆçš„å¯¹è±¡æ˜¯ç»„ä»¶</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>ç»“è®ºï¼šå¯¹äº connect()(MyComponent)</p> <ol><li>connect è°ƒç”¨æ—¶ç”Ÿæˆ 0 å· connect</li> <li>connect()  0 å· connect è°ƒç”¨ï¼Œè¿”å› 1 å· connect çš„è°ƒç”¨ <code>connectHOC()</code> ï¼Œç”Ÿæˆ 2 å· connect(ä¹Ÿæ˜¯ä¸ªå‡½æ•°) ã€‚</li> <li>connect()(MyComponent) ç­‰ä»·äº connect2(MyComponent)ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„ç»„ä»¶</li></ol> <h3 id="redux-ä¸-router"><a href="#redux-ä¸-router" aria-hidden="true" class="header-anchor">#</a> redux ä¸ router</h3> <p>redux æ˜¯çŠ¶æ€ç®¡ç†çš„åº“ï¼Œrouter æ˜¯(å”¯ä¸€)æ§åˆ¶é¡µé¢è·³è½¬çš„åº“ã€‚ä¸¤è€…éƒ½å¾ˆç¾å¥½ï¼Œä½†æ˜¯ä¸ç¾å¥½çš„æ˜¯ä¸¤è€…æ— æ³•ååŒå·¥ä½œã€‚æ¢å¥è¯è¯´ï¼Œå½“è·¯ç”±å˜åŒ–ä»¥åï¼Œstore æ— æ³•æ„ŸçŸ¥åˆ°ã€‚</p> <p>äºæ˜¯ä¾¿æœ‰äº† <code>react-router-redux</code>ã€‚</p> <p><code>react-router-redux</code> æ˜¯ redux çš„ä¸€ä¸ªä¸­é—´ä»¶(ä¸­é—´ä»¶ï¼šJavaScript ä»£ç†æ¨¡å¼çš„å¦ä¸€ç§å®è·µ é’ˆå¯¹ dispatch å®ç°äº†æ–¹æ³•çš„ä»£ç†ï¼Œåœ¨ dispatch action çš„æ—¶å€™å¢åŠ æˆ–è€…ä¿®æ”¹) ï¼Œä¸»è¦ä½œç”¨æ˜¯ï¼š</p> <blockquote><p>åŠ å¼ºäº†React Routeråº“ä¸­historyè¿™ä¸ªå®ä¾‹ï¼Œä»¥å…è®¸å°†historyä¸­æ¥å—åˆ°çš„å˜åŒ–ååº”åˆ°stateä¸­å»ã€‚</p></blockquote> <p><a href="javascript:if(confirm('https://github.com/reactjs/react-router-redux  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/reactjs/react-router-redux'" tppabs="https://github.com/reactjs/react-router-redux" target="_blank" rel="noopener noreferrer">github åœ¨æ­¤<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>ä»ä»£ç ä¸Šè®²ï¼Œä¸»è¦æ˜¯ç›‘å¬äº† history çš„å˜åŒ–ï¼š</p> <p><code>history.listen(location =&gt; analyticsService.track(location.pathname))</code></p> <p>dva åœ¨æ­¤åŸºç¡€ä¸Šåˆè¿›è¡Œäº†ä¸€å±‚ä»£ç†ï¼ŒæŠŠä»£ç†åçš„å¯¹è±¡å½“ä½œåˆå§‹å€¼ä¼ é€’ç»™äº† dva-coreï¼Œæ–¹ä¾¿å…¶åœ¨ model çš„
subscriptions ä¸­ç›‘å¬ router å˜åŒ–ã€‚</p> <p>çœ‹çœ‹ <code>index.js</code> é‡Œ router çš„å®ç°ï¼š</p> <p>1.åœ¨ createOpts ä¸­åˆå§‹åŒ–äº†æ·»åŠ  react-router-redux ä¸­é—´ä»¶çš„æ–¹æ³•å’Œå…¶ reducer ï¼Œæ–¹ä¾¿ dva-core åœ¨åˆ›å»º store çš„æ—¶å€™ç›´æ¥è°ƒç”¨ã€‚</p> <ol start="2"><li>ä½¿ç”¨ patchHistory å‡½æ•°ä»£ç† history.linstenï¼Œå¢åŠ äº†ä¸€ä¸ªå›è°ƒå‡½æ•°çš„åšå‚æ•°(ä¹Ÿå°±æ˜¯è®¢é˜…)ã€‚</li></ol> <blockquote><p>subscriptions çš„ä¸œè¥¿å¯ä»¥æ”¾åœ¨ dva-core é‡Œå†è¯´ï¼Œ</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> createHashHistory <span class="token keyword">from</span> <span class="token string">'history/createHashHistory'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  routerMiddleware<span class="token punctuation">,</span>
  routerReducer <span class="token keyword">as</span> routing<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> core <span class="token keyword">from</span> <span class="token string">'dva-core'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> opts<span class="token punctuation">.</span>history <span class="token operator">||</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> createOpts <span class="token operator">=</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 	åˆå§‹åŒ– react-router-redux çš„ router</span>
    initialReducer<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      routing<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// åˆå§‹åŒ– react-router-redux æ·»åŠ ä¸­é—´ä»¶çš„æ–¹æ³•ï¼Œæ”¾åœ¨æ‰€æœ‰ä¸­é—´ä»¶æœ€å‰é¢</span>
    <span class="token function">setupMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>middlewares<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// ä½¿ç”¨ä»£ç†æ¨¡å¼ä¸º history å¯¹è±¡å¢åŠ æ–°åŠŸèƒ½ï¼Œå¹¶èµ‹ç»™ app</span>
    <span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span>_history <span class="token operator">=</span> <span class="token function">patchHistory</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> createOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> oldAppStart <span class="token operator">=</span> app<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router <span class="token operator">=</span> router<span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
      <span class="token function">isFunction</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token string">`[app.router] router should be function, but got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> router<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>_router <span class="token operator">=</span> router<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

<span class="token comment">// ä½¿ç”¨ä»£ç†æ¨¡å¼æ‰©å±• history å¯¹è±¡çš„ listen æ–¹æ³•ï¼Œæ·»åŠ äº†ä¸€ä¸ªå›è°ƒå‡½æ•°åšå‚æ•°å¹¶åœ¨è·¯ç”±å˜åŒ–æ˜¯ä¸»åŠ¨è°ƒç”¨</span>
<span class="token keyword">function</span> <span class="token function">patchHistory</span><span class="token punctuation">(</span><span class="token parameter">history</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldListen <span class="token operator">=</span> history<span class="token punctuation">.</span>listen<span class="token punctuation">;</span>
  history<span class="token punctuation">.</span><span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">oldListen</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> history<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>å‰§é€ï¼šredux ä¸­åˆ›å»º store çš„æ–¹æ³•ä¸ºï¼š</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// combineReducers æ¥æ”¶çš„å‚æ•°æ˜¯å¯¹è±¡</span>
<span class="token comment">// æ‰€ä»¥ initialReducer çš„ç±»å‹æ˜¯å¯¹è±¡</span>
<span class="token comment">// ä½œç”¨ï¼šå°†å¯¹è±¡ä¸­æ‰€æœ‰çš„ reducer ç»„åˆæˆä¸€ä¸ªå¤§çš„ reducer</span>
<span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">// applyMiddleware æ¥æ”¶çš„å‚æ•°æ˜¯å¯å˜å‚æ•°</span>
<span class="token comment">// æ‰€ä»¥ middleware æ˜¯æ•°ç»„</span>
<span class="token comment">// ä½œç”¨ï¼šå°†æ‰€æœ‰ä¸­é—´ä»¶ç»„æˆä¸€ä¸ªæ•°ç»„ï¼Œä¾æ¬¡æ‰§è¡Œ</span>
<span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>
  <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">,</span>
  initial_state<span class="token punctuation">,</span> <span class="token comment">// è®¾ç½® state çš„åˆå§‹å€¼</span>
  <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middleware<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="è§†å›¾ä¸æ•°æ®-ä¸Š"><a href="#è§†å›¾ä¸æ•°æ®-ä¸Š" aria-hidden="true" class="header-anchor">#</a> è§†å›¾ä¸æ•°æ®(ä¸Š)</h2> <p><code>src/index.js</code> ä¸»è¦å®ç°äº† dva çš„ view å±‚ï¼ŒåŒæ—¶ä¼ é€’äº†ä¸€äº›åˆå§‹åŒ–æ•°æ®åˆ° dva-core æ‰€å®ç°çš„ model å±‚ã€‚å½“ç„¶ï¼Œè¿˜æä¾›äº†ä¸€äº› dva ä¸­å¸¸ç”¨çš„æ–¹æ³•å‡½æ•°ï¼š</p> <ul><li><code>dynamic</code> åŠ¨æ€åŠ è½½(2.0 ä»¥åå®˜æ–¹æä¾› 1.x è‡ªå·±æ‰‹åŠ¨å®ç°å§)</li> <li><code>fetch</code> è¯·æ±‚æ–¹æ³•(å…¶å® dva åªæ˜¯åšäº†ä¸€æŠŠæ¬è¿å·¥)</li> <li><code>saga</code>(æ•°æ®å±‚å¤„ç†å¼‚æ­¥çš„æ–¹æ³•)ã€‚</li></ul> <p>è¿™ä¹ˆçœ‹ dva çœŸçš„æ˜¯å¾ˆè–„çš„ä¸€å±‚å°è£…ã€‚</p> <p>è€Œ dva-core ä¸»è¦è§£å†³äº† model çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ state ç®¡ç†ã€æ•°æ®çš„å¼‚æ­¥åŠ è½½ã€è®¢é˜…-å‘å¸ƒæ¨¡å¼çš„å®ç°ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®å±‚åœ¨åˆ«å¤„ä½¿ç”¨(çœ‹ 2.0 æ›´æ–°ä¹Ÿç¡®å®æ˜¯ä½œè€…çš„æ„å›¾)ã€‚ä½¿ç”¨çš„çŠ¶ä½“å•Šç®¡ç†åº“è¿˜æ˜¯ reduxï¼Œå¼‚æ­¥åŠ è½½çš„è§£å†³æ–¹æ¡ˆæ˜¯ sagaã€‚å½“ç„¶ï¼Œä¸€åˆ‡ä¹Ÿéƒ½å†™åœ¨ index.js å’Œ package.json é‡Œã€‚</p> <h2 id="è§†å›¾ä¸æ•°æ®-ä¸‹"><a href="#è§†å›¾ä¸æ•°æ®-ä¸‹" aria-hidden="true" class="header-anchor">#</a> è§†å›¾ä¸æ•°æ®(ä¸‹)</h2> <p>å¤„ç† React çš„ model å±‚é—®é¢˜æœ‰å¾ˆå¤šç§åŠæ³•ï¼Œæ¯”å¦‚çŠ¶æ€ç®¡ç†å°±ä¸ä¸€å®šè¦ç”¨ Reduxï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Mobx(å†™æ³•ä¼šæ›´æœ‰ MVX æ¡†æ¶çš„æ„Ÿè§‰)ï¼›å¼‚æ­¥æ•°æ®æµä¹Ÿæœªå¿…ä½¿ç”¨ redux-sagaï¼Œredux-thunk æˆ–è€… redux-promise çš„è§£å†³æ–¹å¼ä¹Ÿå¯ä»¥(ä¸è¿‡ç›®å‰çœ‹æ¥ saga æ˜¯ç›¸å¯¹æ›´ä¼˜é›…çš„)ã€‚</p> <p>æ”¾ä¸¤ç¯‡ä¸ªäººæ„Ÿè§‰æ¯”è¾ƒå…¨é¢çš„æŠ€æœ¯æ–‡æ¡£ï¼š</p> <ul><li>é˜®ä¸€å³°å‰è¾ˆçš„ <a href="javascript:if(confirm('http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html'" tppabs="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener noreferrer">redux ä¸‰éƒ¨æ›²<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</li> <li>redux-saga çš„<a href="javascript:if(confirm('http://leonshi.com/redux-saga-in-chinese/docs/api/index.html  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://leonshi.com/redux-saga-in-chinese/docs/api/index.html'" tppabs="http://leonshi.com/redux-saga-in-chinese/docs/api/index.html" target="_blank" rel="noopener noreferrer">ä¸­æ–‡æ–‡æ¡£<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</li></ul> <p>ä»¥åŠä¸¤è€…çš„ githubï¼š</p> <ul><li><a href="javascript:if(confirm('https://github.com/reactjs/redux  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/reactjs/redux'" tppabs="https://github.com/reactjs/redux" target="_blank" rel="noopener noreferrer">redux<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="javascript:if(confirm('https://github.com/redux-saga/redux-saga  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/redux-saga/redux-saga'" tppabs="https://github.com/redux-saga/redux-saga" target="_blank" rel="noopener noreferrer">redux-saga<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>ç„¶åç»§ç»­æ·±æ‰’ <code>dva-core</code>ï¼Œè¿˜æ˜¯å…ˆä» <code>package.json</code> æ‰’èµ·ã€‚</p> <h2 id="package-json"><a href="#package-json" aria-hidden="true" class="header-anchor">#</a> package.json</h2> <p><code>dva-core</code> çš„ <code>package.json</code> ä¸­ä¾èµ–åŒ…å¦‚ä¸‹ï¼š</p> <div class="language-json extra-class"><pre class="language-json"><code>    <span class="token property">&quot;babel-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// ä¸€ä¸ªç¼–è¯‘åæ–‡ä»¶å¼•ç”¨çš„å…¬å…±åº“ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ç¼–è¯‘åçš„æ–‡ä»¶ä½“ç§¯</span>
    <span class="token property">&quot;flatten&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// ä¸€ä¸ªå°†å¤šä¸ªæ•°ç»„å€¼åˆå¹¶æˆä¸€ä¸ªæ•°ç»„çš„åº“</span>
    <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.3.2&quot;</span><span class="token punctuation">,</span><span class="token comment">// ç”¨äºæä¾›å…¨å±€å‡½æ•°æ¯”å¦‚ document çš„å¼•ç”¨</span>
    <span class="token property">&quot;invariant&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.1&quot;</span><span class="token punctuation">,</span><span class="token comment">// ä¸€ä¸ªæœ‰è¶£çš„æ–­è¨€åº“</span>
    <span class="token property">&quot;is-plain-object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªå¯¹è±¡</span>
    <span class="token property">&quot;redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.7.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// redux ï¼Œç®¡ç† react çŠ¶æ€çš„åº“</span>
    <span class="token property">&quot;redux-saga&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.15.4&quot;</span><span class="token punctuation">,</span> <span class="token comment">// å¤„ç†å¼‚æ­¥æ•°æ®æµ</span>
    <span class="token property">&quot;warning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span> <span class="token comment">// åŒæ ·æ˜¯ä¸ªæ–­è¨€åº“ï¼Œä¸è¿‡è¾“å‡ºçš„æ˜¯è­¦å‘Š</span>
</code></pre></div><p>å½“ç„¶å› ä¸ºæ‰“åŒ…è¿˜æ˜¯ç”¨çš„ <code>ruban</code>ï¼Œscript é‡Œæ²¡æœ‰ä»€ä¹ˆå¤ªå¤šæœ‰ç”¨çš„ä¸œè¥¿ã€‚ç»§ç»­ä¾å¾ªæƒ¯ä¾‹ï¼Œå»ç¿» <code>src/index.js</code>ã€‚</p> <h2 id="src-index-js-3"><a href="#src-index-js-3" aria-hidden="true" class="header-anchor">#</a> <code>src/index.js</code></h2> <p><code>src/index</code> çš„æºç åœ¨<a href="javascript:if(confirm('https://github.com/dvajs/dva/blob/master/packages/dva-core/src/index.js  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/blob/master/packages/dva-core/src/index.js'" tppabs="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/index.js" target="_blank" rel="noopener noreferrer">è¿™é‡Œ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>åœ¨ <code>dva</code> çš„ <code>src/index.js</code> é‡Œï¼Œé€šè¿‡ä¼ é€’ 2 ä¸ªå˜é‡ <code>opts</code> å’Œ <code>createOpts</code> å¹¶è°ƒç”¨ <code>core.create</code>ï¼Œ<code>dva</code> åˆ›å»ºäº†ä¸€ä¸ª app å¯¹è±¡ã€‚å…¶ä¸­ <code>opts</code> æ˜¯ä½¿ç”¨è€…æ·»åŠ çš„æ§åˆ¶é€‰é¡¹ï¼Œ<code>createOpts</code> åˆ™æ˜¯åˆå§‹åŒ–äº† reducer ä¸ redux çš„ä¸­é—´ä»¶ã€‚</p> <p><code>dva-core</code> çš„ <code>src/index.js</code> é‡Œä¾¿æ˜¯è¿™ä¸ª app å¯¹è±¡çš„å…·ä½“åˆ›å»ºè¿‡ç¨‹ä»¥åŠåŒ…å«çš„æ–¹æ³•ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">hooksAndOpts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> createOpts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    initialReducer<span class="token punctuation">,</span>
    setupApp <span class="token operator">=</span> noop<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> createOpts<span class="token punctuation">;</span>

  <span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">filterHooks</span><span class="token punctuation">(</span>hooksAndOpts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span>
    _models<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token function">prefixNamespace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>dvaModel <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    _store<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    _plugin<span class="token punctuation">:</span> plugin<span class="token punctuation">,</span>
    use<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">,</span>
    model<span class="token punctuation">,</span>
    start<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
  	<span class="token comment">// .... æ–¹æ³•çš„å®ç°</span>
	
	<span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// model æ–¹æ³•</span>
	<span class="token punctuation">}</span>
	
	functoin <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// Start æ–¹æ³•</span>
	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>æˆ‘æœ€å¼€å§‹å¾ˆä¸ä¹ æƒ¯ JavaScript å°±æ˜¯å› ä¸º JavaScript è¿˜æ˜¯ä¸€ä¸ªå‡½æ•°å‘çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿå°±æ˜¯å‡½æ•°é‡Œå¯ä»¥å®šä¹‰å‡½æ•°ï¼Œè¿”å›å€¼ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°ï¼Œclass æœ€åä¹Ÿæ˜¯è¢«è§£é‡Šæˆå‡½æ•°ã€‚åœ¨ dva-core é‡Œåˆ›å»ºäº† app å¯¹è±¡ï¼Œä½†æ˜¯æŠŠ model å’Œ start çš„å®šä¹‰æ”¾åœ¨äº†åé¢ã€‚ä¸€å¼€å§‹å¯¹è¿™ç§ç®€å†™æ²¡çœ‹æ‡‚ï¼Œåæ¥ç†Ÿæ‚‰äº†ä»¥åå‘ç°ç¡®å®å¥½ç†è§£ã€‚ä¸€çœ¼å°±å¯ä»¥çœ‹åˆ° app æ‰€åŒ…å«çš„æ–¹æ³•ï¼Œå¦‚æœéœ€è¦ç ”ç©¶å…·ä½“æ–¹æ³•çš„è¯æ‰éœ€è¦å‘åçœ‹ã€‚</p></blockquote> <p><a href="javascript:if(confirm('https://github.com/dvajs/dva/blob/master/packages/dva-core/src/Plugin.js  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/blob/master/packages/dva-core/src/Plugin.js'" tppabs="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/Plugin.js" target="_blank" rel="noopener noreferrer">Plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æ˜¯ä½œè€…è®¾ç½®çš„ä¸€å †<strong>é’©å­</strong>æ€§ç›‘å¬å‡½æ•°â€”â€”å³æ˜¯åœ¨ç¬¦åˆæŸäº›æ¡ä»¶çš„æƒ…å†µä¸‹ä¸‹(dva ä½œè€…)è¿›è¡Œæ‰‹åŠ¨è°ƒç”¨ã€‚è¿™æ ·ä½¿ç”¨è€…åªè¦æŒ‰ç…§ä½œè€…è®¾å®šè¿‡çš„å…³é”®è¯ä¼ é€’å›è°ƒå‡½æ•°ï¼Œåœ¨è¿™äº›æ¡ä»¶ä¸‹ä¾¿ä¼šè‡ªåŠ¨è§¦å‘ã€‚</p> <blockquote><p>æœ‰è¶£çš„æ˜¯ï¼Œæˆ‘æœ€åˆç†è§£<strong>é’©å­</strong>çš„æ¦‚å¿µæ˜¯åœ¨ Angular é‡Œã€‚ä¸ºäº†èƒ½åƒ React ä¸€æ ·ä¼˜é›…çš„æ§åˆ¶ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼ŒAngular è®¾ç½®äº†ä¸€å †æ¥å£(å› ä¸ºä½¿ç”¨çš„æ˜¯ tsï¼Œæ‰€ä»¥ Angular é‡Œæœ‰ç±»å’Œæ¥å£çš„åŒºåˆ†)ã€‚åªè¦ç»„ä»¶å®ç°(implements)å¯¹åº”çš„æ¥å£â€”â€”â€”â€”æˆ–è€…ç§°ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œåœ¨å¯¹åº”çš„æ¡ä»¶ä¸‹å°±ä¼šè¿è¡Œæ¥å£çš„æ–¹æ³•ã€‚</p></blockquote> <h4 id="plugin-ä¸-plugin-use"><a href="#plugin-ä¸-plugin-use" aria-hidden="true" class="header-anchor">#</a> Plugin ä¸ plugin.use</h4> <p>Plugin ä¸ plugin.use éƒ½æœ‰ä½¿ç”¨æ•°ç»„çš„ reduce æ–¹æ³•çš„è¡Œä¸ºï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'onError'</span><span class="token punctuation">,</span>
  <span class="token string">'onStateChange'</span><span class="token punctuation">,</span>
  <span class="token string">'onAction'</span><span class="token punctuation">,</span>
  <span class="token string">'onHmr'</span><span class="token punctuation">,</span>
  <span class="token string">'onReducer'</span><span class="token punctuation">,</span>
  <span class="token string">'onEffect'</span><span class="token punctuation">,</span>
  <span class="token string">'extraReducers'</span><span class="token punctuation">,</span>
  <span class="token string">'extraEnhancers'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">filterHooks</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœå¯¹è±¡çš„ key åœ¨ hooks æ•°ç»„ä¸­</span>
  <span class="token comment">// ä¸º memo å¯¹è±¡æ·»åŠ æ–°çš„ keyï¼Œå€¼ä¸º obj å¯¹åº” key çš„å€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> hooks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
		ç­‰åŒäº
		
		this.hooks = {
			onError: [],
			onStateChange:[],
			....
			extraEnhancers: []
		}
	*/</span>
  <span class="token punctuation">}</span>

  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'plugin.use: plugin should be plain object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> plugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`plugin.use: unknown plugin property: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'extraEnhancers'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> plugin<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å…¶ä»–æ–¹æ³•</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>æ„é€ å™¨ä¸­çš„ <code>reduce</code> åˆå§‹åŒ–äº†ä¸€ä¸ªä»¥ <code>hooks</code> æ•°ç»„æ‰€æœ‰å…ƒç´ ä¸º keyï¼Œå€¼ä¸ºç©ºæ•°ç»„çš„å¯¹è±¡ï¼Œå¹¶èµ‹ç»™äº† class çš„ç§æœ‰å˜é‡ <code>this.hooks</code>ã€‚</p></li> <li><p><code>filterHooks</code> é€šè¿‡ <code>reduce</code> è¿‡æ»¤äº† <code>hooks</code> æ•°ç»„ä»¥å¤–çš„é’©å­ã€‚</p></li> <li><p><code>use</code> ä¸­ä½¿ç”¨ <code>hasOwnProperty</code> åˆ¤æ–­ <code>key</code> æ˜¯ <code>plugin</code> çš„è‡ªèº«å±æ€§è¿˜æ˜¯ç»§æ‰¿å±æ€§ï¼Œä½¿ç”¨åŸå‹é“¾è°ƒç”¨è€Œä¸æ˜¯ <code>plugin.hasOwnProperty()</code> æ˜¯é˜²æ­¢ä½¿ç”¨è€…æ•…æ„æ£ä¹±åœ¨ <code>plugin</code> è‡ªå·±å†™ä¸€ä¸ª <code>hasOwnProperty = () =&gt; false // è¿™æ ·æ— è®ºå¦‚ä½•è°ƒç”¨ plugin.hasOwnProperty() è¿”å›å€¼éƒ½æ˜¯ false</code>ã€‚</p></li> <li><p><code>use</code> ä¸­ä½¿ç”¨ <code>reduce</code> ä¸º <code>this.hooks</code> æ·»åŠ äº† <code>plugin[key]</code> ã€‚</p></li></ul> <h2 id="model-æ–¹æ³•"><a href="#model-æ–¹æ³•" aria-hidden="true" class="header-anchor">#</a> model æ–¹æ³•</h2> <p><code>model</code> æ˜¯ app æ·»åŠ  model çš„æ–¹æ³•ï¼Œåœ¨ <strong>dva é¡¹ç›®</strong> çš„ index.js æ˜¯è¿™ä¹ˆç”¨çš„ã€‚</p> <blockquote><p>app.model(require('./models/example'));</p></blockquote> <p>åœ¨ <code>dva</code> ä¸­æ²¡å¯¹ model åšä»»ä½•å¤„ç†ï¼Œæ‰€ä»¥ <code>dva-core</code> ä¸­çš„ model å°±æ˜¯ <strong>dva é¡¹ç›®</strong> é‡Œè°ƒç”¨çš„ modelã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkModel</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">prefixNamespace</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</code></pre></div><ul><li><p><code>checkModel</code> ä¸»è¦æ˜¯ç”¨ <code>invariant</code> å¯¹ä¼ å…¥çš„ model è¿›è¡Œäº†åˆæ³•æ€§æ£€æŸ¥ã€‚</p></li> <li><p><code>prefixNamespace</code> åˆä½¿ç”¨ reduce å¯¹æ¯ä¸€ä¸ª model åšå¤„ç†ï¼Œä¸º model çš„ reducers å’Œ effects ä¸­çš„æ–¹æ³•æ·»åŠ äº† <code>${namespace}/</code> çš„å‰ç¼€ã€‚</p></li></ul> <blockquote><p>Ever wonder why we dispatch the action like this in dva ? <code>dispatch({type: 'example/loadDashboard'</code></p></blockquote> <h2 id="start-æ–¹æ³•"><a href="#start-æ–¹æ³•" aria-hidden="true" class="header-anchor">#</a> start æ–¹æ³•</h2> <p><code>start</code> æ–¹æ³•æ˜¯ <code>dva-core</code> çš„æ ¸å¿ƒï¼Œåœ¨ <code>start</code> æ–¹æ³•é‡Œï¼Œdva å®Œæˆäº† <strong><code>store</code> åˆå§‹åŒ–</strong> ä»¥åŠ <strong><code>redux-saga</code> çš„è°ƒç”¨</strong>ã€‚æ¯”èµ· <code>dva</code> çš„ <code>start</code>ï¼Œå®ƒå¼•å…¥äº†æ›´å¤šçš„è°ƒç”¨æ–¹å¼ã€‚</p> <p>ä¸€æ­¥ä¸€æ­¥åˆ†æï¼š</p> <h3 id="onerror"><a href="#onerror" aria-hidden="true" class="header-anchor">#</a> <code>onError</code></h3> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token function-variable function">onError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> err <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err<span class="token punctuation">.</span><span class="token function-variable function">preventDefault</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          err<span class="token punctuation">.</span>_dontReject <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">'onError'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™æ˜¯ä¸€ä¸ªå…¨å±€é”™è¯¯å¤„ç†ï¼Œè¿”å›äº†ä¸€ä¸ªæ¥æ”¶é”™è¯¯å¹¶å¤„ç†çš„å‡½æ•°ï¼Œå¹¶ä»¥ <code>err</code> å’Œ <code>app._store.dispatch</code> ä¸ºå‚æ•°æ‰§è¡Œè°ƒç”¨ã€‚</p> <p>çœ‹ä¸€ä¸‹ <code>plugin.apply</code> çš„å®ç°ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> defaultHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">;</span>
	<span class="token comment">/* é€šè¿‡ validApplyHooks è¿›è¡Œè¿‡æ»¤ï¼Œ apply æ–¹æ³•åªèƒ½åº”ç”¨åœ¨å…¨å±€æŠ¥é”™æˆ–è€…çƒ­æ›´æ›¿ä¸Š */</span> 
    <span class="token keyword">const</span>  validApplyHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'onError'</span><span class="token punctuation">,</span> <span class="token string">'onHmr'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>validApplyHooks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`plugin.apply: hook </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> cannot be applied`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* ä»é’©å­ä¸­æ‹¿å‡ºæŒ‚è½½çš„å›è°ƒå‡½æ•° ï¼ŒæŒ‚è½½åŠ¨ä½œè§ use éƒ¨åˆ†*/</span>
    <span class="token keyword">const</span> fns <span class="token operator">=</span> hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// å¦‚æœæœ‰å›è°ƒæ‰§è¡Œå›è°ƒ</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> fns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// æ²¡æœ‰å›è°ƒç›´æ¥æŠ›å‡ºé”™è¯¯</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">defaultHandler</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/*
		è¿™é‡Œ defaultHandler ä¸º (err) =&gt; {
          throw new Error(err.stack || err);
        }
		*/</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="sagamiddleware"><a href="#sagamiddleware" aria-hidden="true" class="header-anchor">#</a> <code>sagaMiddleware</code></h3> <p>ä¸‹ä¸€è¡Œä»£ç æ˜¯ï¼š</p> <blockquote><p><code>const sagaMiddleware = createSagaMiddleware();</code></p></blockquote> <p>å’Œ <code>redux-sagas</code> çš„å…¥é—¨æ•™ç¨‹æœ‰ç‚¹å·®å¼‚ï¼Œå› ä¸ºæ­£ç»Ÿçš„æ•™ç¨‹ä¸Šæ·»åŠ  sagas ä¸­é—´ä»¶çš„æ–¹æ³•æ˜¯ï¼š <code>createSagaMiddleware(...sagas)</code></p> <blockquote><p>sagas ä¸ºå«æœ‰ saga æ–¹æ³•çš„ generator å‡½æ•°æ•°ç»„ã€‚</p></blockquote> <p>ä½†æ˜¯ api é‡Œç¡®å®è¿˜æåˆ°ï¼Œè¿˜æœ‰ä¸€~<s>æ‹›ä»å¤©è€Œé™çš„æŒæ³•</s>~ç§åŠ¨æ€è°ƒç”¨çš„æ–¹å¼ï¼š</p> <blockquote><p><code>const task = sagaMiddleware.run(dynamicSaga)</code></p></blockquote> <p>äºæ˜¯ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>	  <span class="token keyword">const</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token comment">// ...</span>
      <span class="token keyword">const</span> sagas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>initialReducer
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	reducers<span class="token punctuation">[</span>m<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getReducer</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>reducers<span class="token punctuation">,</span> m<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">)</span> sagas<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">_getSaga</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">,</span> m<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'onEffect'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ....</span>

      store<span class="token punctuation">.</span>runSaga <span class="token operator">=</span> sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">;</span>
      <span class="token comment">// Run sagas</span>
      sagas<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="sagas"><a href="#sagas" aria-hidden="true" class="header-anchor">#</a> <code>sagas</code></h3> <p>é‚£ä¹ˆ sagas æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      middleware<span class="token punctuation">:</span> promiseMiddleware<span class="token punctuation">,</span>
      resolve<span class="token punctuation">,</span>
      reject<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createPromiseMiddleware</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>_getSaga <span class="token operator">=</span> <span class="token function">getSaga</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> sagas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">)</span> sagas<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">_getSaga</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">,</span> m<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'onEffect'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>æ˜¾ç„¶ï¼Œsagas æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢çš„å…ƒç´ æ˜¯ç”¨ <code>app._getSaga</code> å¤„ç†åçš„è¿”å›ç»“æœï¼Œè€Œ <code>app._getSaga</code> åˆå’Œä¸Šé¢ createPromiseMiddleware ä»£ç† app åè¿”å›çš„å¯¹è±¡æœ‰å¾ˆå¤§å…³ç³»ã€‚</p> <h4 id="createpromisemiddleware"><a href="#createpromisemiddleware" aria-hidden="true" class="header-anchor">#</a> <code>createPromiseMiddleware</code></h4> <p>createPromiseMiddleware çš„ä»£ç <a href="javascript:if(confirm('https://github.com/dvajs/dva/blob/master/packages/dva-core/src/createPromiseMiddleware.js  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/blob/master/packages/dva-core/src/createPromiseMiddleware.js'" tppabs="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/createPromiseMiddleware.js" target="_blank" rel="noopener noreferrer">åœ¨æ­¤<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p> <p>å¦‚æœçœ‹ç€è§‰å¾—çœ¼ç†Ÿï¼Œé‚£è‚¯å®šä¸æ˜¯å› ä¸ºçœ‹è¿‡ redux-promise æºç çš„ç¼˜æ•…ï¼Œ:-pã€‚</p> <h5 id="middleware"><a href="#middleware" aria-hidden="true" class="header-anchor">#</a> <code>middleware</code></h5> <p><code>middleware</code> æ˜¯ä¸€ä¸ª redux çš„ä¸­é—´ä»¶ï¼Œå³åœ¨ä¸å½±å“ redux æœ¬èº«åŠŸèƒ½çš„æƒ…å†µä¸‹ä¸ºå…¶æ·»åŠ äº†æ–°ç‰¹æ€§çš„ä»£ç ã€‚redux çš„ä¸­é—´ä»¶é€šè¿‡æ‹¦æˆª action æ¥å®ç°å…¶ä½œç”¨çš„ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEffect</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// .... resolve ,reject</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
    <span class="token keyword">function</span> <span class="token function">isEffect</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// dva é‡Œ action çš„ type æœ‰å›ºå®šæ ¼å¼ï¼š model.namespace/model.effects</span>
		<span class="token comment">// const [namespace] = type.split(NAMESPACE_SEP); æ˜¯ es6 è§£æ„çš„å†™æ³•</span>
		<span class="token comment">// ç­‰åŒäº const namespace = type.split(NAMESPACE_SEP)[0];</span>
		<span class="token comment">// NAMESPACE_SEP çš„å€¼æ˜¯ `/`</span>
    	<span class="token keyword">const</span> <span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">NAMESPACE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// æ ¹æ® namespace è¿‡æ»¤å‡ºå¯¹åº”çš„ model</span>
    	<span class="token keyword">const</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>namespace <span class="token operator">===</span> namespace<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// å¦‚æœ model å­˜åœ¨å¹¶ä¸” model.effects[type] ä¹Ÿå­˜åœ¨ï¼Œé‚£å¿…ç„¶æ˜¯ effects</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">.</span>effects <span class="token operator">&amp;&amp;</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    	<span class="token punctuation">}</span>

    	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>const middleware = ({dispatch}) =&gt; next =&gt; (action) =&gt; {... return next(action)} åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ä¸­é—´ä»¶å†™æ³•ã€‚åœ¨ return next(action) ä¹‹å‰å¯ä»¥å¯¹ action åšå„ç§å„æ ·çš„æ“ä½œã€‚å› ä¸ºæ­¤ä¸­é—´ä»¶æ²¡ç”¨åˆ° dispatch æ–¹æ³•ï¼Œæ‰€ä»¥çœç•¥äº†ã€‚</p></blockquote> <p>æœ¬æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œå¦‚æœ dispatch çš„ action æŒ‡å‘çš„æ˜¯ model é‡Œçš„ effectsï¼Œé‚£ä¹ˆè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ã€‚æ­¤ Promise çš„å¯¹è±¡çš„è§£å†³( resolve )æˆ–è€…é©³å›æ–¹æ³• ( reject ) æ”¾åœ¨ map å¯¹è±¡ä¸­ã€‚å¦‚æœæ˜¯é effects (é‚£å°±æ˜¯ action äº†)ï¼Œæ”¾è¡Œã€‚</p> <p>æ¢å¥è¯è¯´ï¼Œmiddleware æ‹¦æˆªäº†æŒ‡å‘ effects çš„ actionã€‚</p> <h5 id="ç¥å¥‡çš„-bind"><a href="#ç¥å¥‡çš„-bind" aria-hidden="true" class="header-anchor">#</a> ç¥å¥‡çš„ bind</h5> <p>bind çš„ä½œç”¨æ˜¯ç»‘å®šæ–°çš„å¯¹è±¡ï¼Œç”Ÿæˆæ–°å‡½æ•°æ˜¯å¤§å®¶éƒ½çŸ¥é“æ¦‚å¿µã€‚ä½†æ˜¯ bind ä¹Ÿå¯ä»¥æå‰è®¾å®šå¥½å‡½æ•°çš„æŸäº›å‚æ•°ç”Ÿæˆæ–°å‡½æ•°ï¼Œç­‰åˆ°æœ€åä¸€ä¸ªå‚æ•°ç¡®å®šæ—¶ç›´æ¥è°ƒç”¨ã€‚</p> <blockquote><p>JavaScript çš„å‚æ•°æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„ï¼Ÿ<a href="javascript:if(confirm('https://juejin.im/post/598d0b7ff265da3e1727c491  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://juejin.im/post/598d0b7ff265da3e1727c491'" tppabs="https://juejin.im/post/598d0b7ff265da3e1727c491" target="_blank" rel="noopener noreferrer">JavaScript ä¸“é¢˜ä¹‹å‡½æ•°æŸ¯é‡ŒåŒ–<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚ä½œè€…ï¼š<a href="javascript:if(confirm('https://juejin.im/user/58e4b9b261ff4b006b3227f4  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://juejin.im/user/58e4b9b261ff4b006b3227f4'" tppabs="https://juejin.im/user/58e4b9b261ff4b006b3227f4" target="_blank" rel="noopener noreferrer">å†´ç¾½<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚æ–‡ç« æ¥æºï¼š<a href="javascript:if(confirm('https://juejin.im/timeline  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://juejin.im/timeline'" tppabs="https://juejin.im/timeline" target="_blank" rel="noopener noreferrer">æ˜é‡‘<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>è¿™æ®µä»£ç æ°å¥½å°±æ˜¯ bind çš„ä¸€ç§å®è·µæ–¹å¼ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          resolve<span class="token punctuation">:</span> <span class="token function">wrapped</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">,</span>
          reject<span class="token punctuation">:</span> <span class="token function">wrapped</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ....</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">function</span> <span class="token function">wrapped</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">delete</span> map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
   <span class="token keyword">return</span> <span class="token punctuation">{</span>
    middleware<span class="token punctuation">,</span>
    resolve<span class="token punctuation">,</span>
    reject<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>åˆ†æè¿™æ®µä»£ç ï¼Œdva æ˜¯è¿™æ ·åšçš„ï¼š</p> <ol><li>é€šè¿‡ <code>wrapped.bind(null, type, resolve)</code> äº§ç”Ÿäº†ä¸€ä¸ªæ–°å‡½æ•°ï¼Œå¹¶ä¸”èµ‹å€¼ç»™åŒ¿åå¯¹è±¡çš„ resolve å±æ€§(reject åŒç†)ã€‚</li></ol> <blockquote><p>1.1 wrap æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œé€šè¿‡ bind å·²ç»è®¾å®šå¥½äº†ä¸¤ä¸ªã€‚<code>wrapped.bind(null, type, resolve)</code> ç­‰åŒäº <code>wrap(type, resolve, xxx)</code>ï¼ˆ<strong>æ­¤å¤„  <code>resolve</code> æ˜¯ Promise å¯¹è±¡ä¸­çš„</strong>ï¼‰ã€‚</p></blockquote> <blockquote><p>1.2 é€šè¿‡ bind èµ‹ç»™åŒ¿åå¯¹è±¡çš„ resolve å±æ€§åï¼ŒåŒ¿åå¯¹è±¡.resolve(xxxx) ç­‰åŒäº wrap(type, resolve, xxx)ï¼Œå³ reslove(xxx)ã€‚</p></blockquote> <ol start="2"><li><p>ä½¿ç”¨ type åœ¨ map å¯¹è±¡ä¸­ä¿å­˜æ­¤åŒ¿åå¯¹è±¡ï¼Œè€Œ type æ˜¯ action çš„ typeï¼Œå³ namespace/effects çš„å½¢å¼ï¼Œæ–¹ä¾¿ä¹‹åè¿›è¡Œè°ƒç”¨ã€‚</p></li> <li><p>return å‡ºçš„ resolve æ¥æ”¶ type å’Œ args ä¸¤ä¸ªå‚æ•°ã€‚type ç”¨æ¥åœ¨ map ä¸­å¯»æ‰¾ 1 é‡Œçš„åŒ¿åå‡½æ•°ï¼Œargs ç”¨æ¥åƒ 1.2 é‡Œé‚£æ ·æ‰§è¡Œã€‚</p></li></ol> <blockquote><p>è¿™æ ·åšçš„ä½œç”¨æ˜¯ï¼šåˆ†ç¦»äº† promise ä¸ promise çš„æ‰§è¡Œã€‚åœ¨å‡½æ•°çš„ä½œç”¨åŸŸå¤–ä¾ç„¶å¯ä»¥è®¿é—®åˆ°å‡½æ•°çš„å†…éƒ¨å˜é‡ï¼Œæ¢è¨€ä¹‹ï¼šé—­åŒ…ã€‚</p></blockquote> <h4 id="getsaga"><a href="#getsaga" aria-hidden="true" class="header-anchor">#</a> <code>getSaga</code></h4> <p>å¯¼å‡ºçš„ <code>resolve</code> ä¸ <code>reject</code> æ–¹æ³•ï¼Œé€šè¿‡ bind å…ˆè®¾ç½®è¿›äº† <code>getSaga</code> (åŒæ—¶ä¹Ÿèµ‹ç»™äº† <code>app._getSaga</code>)ï¼Œsagas æœ€ç»ˆä¹Ÿå°† <code>getSaga</code> çš„è¿”å›å€¼æ”¾å…¥äº†æ•°ç»„ã€‚</p> <p><a href="javascript:if(confirm('https://github.com/dvajs/dva/blob/master/packages/dva-core/src/getSaga.js  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/blob/master/packages/dva-core/src/getSaga.js'" tppabs="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/getSaga.js" target="_blank" rel="noopener noreferrer">getSaga æºç <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getSaga</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> effects<span class="token punctuation">,</span> model<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> effects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token function">getWatcher</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> key<span class="token punctuation">,</span> effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// å°† watcher åˆ†ç¦»åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œ</span>
        <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// åŒæ—¶ fork äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºåœ¨ model å¸è½½åå–æ¶ˆæ­£åœ¨è¿›è¡Œä¸­çš„ task</span>
		<span class="token comment">// `${model.namespace}/@@CANCEL_EFFECTS` çš„å‘å‡ºåŠ¨ä½œåœ¨ index.js çš„ start æ–¹æ³•ä¸­ï¼Œunmodel æ–¹æ³•é‡Œã€‚</span>
        <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>model<span class="token punctuation">.</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/@@CANCEL_EFFECTS`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>getSaga</code> æœ€ç»ˆè¿”å›äº†ä¸€ä¸ª <a href="javascript:if(confirm('http://www.ruanyifeng.com/blog/2015/04/generator.html  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://www.ruanyifeng.com/blog/2015/04/generator.html'" tppabs="http://www.ruanyifeng.com/blog/2015/04/generator.html" target="_blank" rel="noopener noreferrer">generator å‡½æ•°<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p> <p>åœ¨è¯¥å‡½æ•°éå†äº† <strong>model ä¸­ effects å±æ€§</strong> çš„æ‰€æœ‰æ–¹æ³•ï¼ˆæ³¨ï¼šåŒæ ·æ˜¯ generator å‡½æ•°ï¼‰ã€‚ç»“åˆ <code>index.js</code> é‡Œçš„ <code>for (const m of app._models)</code>ï¼Œè¯¥éå†é’ˆå¯¹æ‰€æœ‰çš„ modelã€‚</p> <p>å¯¹äºæ¯ä¸€ä¸ª effectï¼ŒgetSaga ç”Ÿæˆäº†ä¸€ä¸ª watcher ï¼Œå¹¶ä½¿ç”¨ saga å‡½æ•°çš„ <strong>fork</strong> å°†è¯¥å‡½æ•°åˆ‡åˆ†åˆ°å¦ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­å»ï¼ˆç”Ÿæˆäº†ä¸€ä¸ª task å¯¹è±¡ï¼‰ã€‚åŒæ—¶ä¸ºäº†æ–¹ä¾¿å¯¹è¯¥çº¿ç¨‹è¿›è¡Œæ§åˆ¶ï¼Œåœ¨æ­¤ fork äº†ä¸€ä¸ª generator å‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­æ‹¦æˆªäº†å–æ¶ˆ effect çš„ actionï¼ˆäº‹å®ä¸Šï¼Œåº”è¯¥æ˜¯å¸è½½effect æ‰€åœ¨ model çš„ actionï¼‰ï¼Œä¸€æ—¦ç›‘å¬åˆ°åˆ™ç«‹åˆ»å–æ¶ˆåˆ†å‡ºå»çš„ task çº¿ç¨‹ã€‚</p> <h5 id="getwatcher"><a href="#getwatcher" aria-hidden="true" class="header-anchor">#</a> getWatcher</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getWatcher</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> key<span class="token punctuation">,</span> _effect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> effect <span class="token operator">=</span> _effect<span class="token punctuation">;</span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token string">'takeEvery'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> ms<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// effect æ˜¯æ•°ç»„è€Œä¸æ˜¯å‡½æ•°çš„æƒ…å†µä¸‹æš‚ä¸è€ƒè™‘</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">sagaWithCatch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// .... sagaWithCatch çš„é€»è¾‘</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> sagaWithOnEffect <span class="token operator">=</span> <span class="token function">applyOnEffect</span><span class="token punctuation">(</span>onEffect<span class="token punctuation">,</span> sagaWithCatch<span class="token punctuation">,</span> model<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'watcher'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> sagaWithCatch<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'takeLatest'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">takeLatest</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'throttle'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">throttle</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createEffects</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// createEffects(model) çš„é€»è¾‘</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">applyOnEffect</span><span class="token punctuation">(</span><span class="token parameter">fns<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> fns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effect <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> sagaEffects<span class="token punctuation">,</span> model<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å…ˆä¸è€ƒè™‘ effect çš„å±æ€§æ˜¯æ•°ç»„è€Œä¸æ˜¯æ–¹æ³•çš„æƒ…å†µã€‚</p> <p><code>getWatcher</code> æ¥æ”¶å…­ä¸ªå‚æ•°ï¼š</p> <ul><li><code>resolve/reject</code>: ä¸­é—´ä»¶ <code>middleware</code> çš„ res å’Œ rej æ–¹æ³•ã€‚</li> <li><code>key</code>:ç»è¿‡ prefixNamespace è½¬ä¹‰åçš„ effect æ–¹æ³•åï¼Œnamespace/effectï¼ˆä¹Ÿæ˜¯è°ƒç”¨ action æ—¶çš„ typeï¼‰ã€‚
-<code>_effect</code>:effects ä¸­ key å±æ€§æ‰€æŒ‡å‘çš„ generator å‡½æ•°ã€‚</li> <li><code>model</code>ï¼š model</li> <li><code>onError</code>ï¼š ä¹‹å‰å®šä¹‰è¿‡çš„æ•è·å…¨å±€é”™è¯¯çš„æ–¹æ³•</li> <li><code>onEffect</code>ï¼šplugin.use ä¸­ä¼ å…¥çš„åœ¨è§¦å‘ effect æ—¶æ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼ˆé’©å­å‡½æ•°ï¼‰</li></ul> <p><code>applyOnEffect</code> å¯¹ effect è¿›è¡Œäº†åŠ¨æ€ä»£ç†ï¼Œåœ¨ä¿è¯ effect ï¼ˆå³ <code>_effect</code>ï¼‰æ­£å¸¸è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œä¸ºæœŸæ·»åŠ äº† fns çš„å›è°ƒå‡½æ•°æ•°ç»„(å³ <code>onEffect</code>)ã€‚ä½¿å¾—åœ¨ effect æ‰§è¡Œæ—¶ï¼Œ <code>onEffect</code> å†…çš„æ¯ä¸€ä¸ªå›è°ƒå‡½æ•°éƒ½å¯ä»¥è¢«è§¦å‘ã€‚</p> <p>å› ä¸ºæ²¡æœ‰ç»è¿‡ effects çš„å±æ€§æ˜¯æ•°ç»„çš„æƒ…å†µï¼Œæ‰€ä»¥ <code>type</code> çš„å€¼æ˜¯ <code>takeEvery</code>ï¼Œä¹Ÿå°±æ˜¯ç›‘å¬æ¯ä¸€ä¸ªå‘å‡ºçš„ action ï¼Œå³ <code>getWatcher</code> çš„è¿”å›å€¼æœ€ç»ˆèµ°çš„æ˜¯ switch çš„ default é€‰é¡¹:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
	  
</code></pre></div><p>æ¢å¥è¯è¯´ï¼Œæ¯æ¬¡å‘å‡ºæŒ‡å‘ effects çš„å‡½æ•°éƒ½ä¼šè°ƒç”¨ <code>sagaWithOnEffect</code>ã€‚</p> <p>æ ¹æ® <code>const sagaWithOnEffect = applyOnEffect(onEffect, sagaWithCatch, model, key);</code> çš„æ‰§è¡Œæƒ…å†µï¼Œå¦‚æœ onEffect çš„æ’ä»¶ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œ<code>sagaWithOnEffect</code> çš„å€¼ä¸º <code>sagaWithCatch</code>ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">sagaWithCatch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NAMESPACE_SEP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@@start`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">createEffects</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NAMESPACE_SEP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@@end`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>_dontReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>åœ¨ <code>sagaWithOnEffect</code> å‡½æ•°ä¸­ï¼Œsagas ä½¿ç”¨ä¼ å…¥çš„å‚æ•°(ä¹Ÿå°±æ˜¯ action)æ‰§è¡Œäº†å¯¹åº”çš„ model ä¸­ å¯¹åº”çš„ effect æ–¹æ³•ï¼ŒåŒæ—¶å°†è¿”å›å€¼ä½¿ç”¨ä¹‹å‰ä¿å­˜åœ¨ map é‡Œçš„ resolve è¿”å›äº†å…¶è¿”å›å€¼ã€‚åŒæ—¶åœ¨æ‰§è¡Œ effect æ–¹æ³•çš„æ—¶å€™ï¼Œå°† saga æœ¬èº«çš„æ‰€æœ‰æ–¹æ³•(putã€callã€fork ç­‰ç­‰)ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œä½¿ç”¨ <code>concat</code> æ‹¼æ¥åœ¨ action çš„åé¢ã€‚åœ¨æ‰§è¡Œ effect æ–¹æ³•å‰ï¼Œåˆå‘å‡ºäº† start å’Œ end ä¸¤ä¸ª actionï¼Œæ–¹ä¾¿ onEffect çš„æ’ä»¶è¿›è¡Œæ‹¦æˆªå’Œè°ƒç”¨ã€‚</p> <p>å› æ­¤ï¼Œå¯¹äº <code>if (m.effects) sagas.push(app._getSaga(m.effects, m, onError, plugin.get('onEffect')));</code>ã€‚</p> <ol><li>dva é€šè¿‡ <code>app._getSaga(m.effects, m, onError, plugin.get('onEffect'))</code> è¿”å›äº†ä¸€ä¸ª genenrator å‡½æ•°ã€‚</li> <li>åœ¨ genenrator å‡½æ•°ä¸­æ‰‹åŠ¨ fork å‡ºä¸€ä¸ª watcher å‡½æ•°çš„ç›‘å¬çº¿ç¨‹(å½“ç„¶ä¹Ÿ fork äº†å–æ¶ˆçº¿ç¨‹çš„åŠŸèƒ½)ã€‚</li> <li>è¯¥å‡½æ•°(åœ¨æ™®é€šçŠ¶æ€ä¸‹)æ˜¯ä¸€ä¸ª takeEvery çš„é˜»å¡æ˜¯çº¿ç¨‹ï¼Œæ¥æ”¶ 2 ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç›‘å¬çš„ actionï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç›‘å¬åˆ° action åçš„å›è°ƒå‡½æ•°ã€‚</li> <li>(æ™®é€šçŠ¶æ€ä¸‹)çš„å›è°ƒå‡½æ•°ï¼Œå°±æ˜¯æ‰‹åŠ¨è°ƒç”¨äº† model é‡Œ effects ä¸­å¯¹åº”å±æ€§çš„å‡½æ•°ã€‚åœ¨æ­¤ä¹‹å‰ä¹‹åå‘å‡ºäº† <code>start</code> å’Œ <code>end</code> çš„ actionï¼ŒåŒæ—¶ç”¨ä¹‹å‰ promise ä¸­é—´ä»¶ä¿å­˜åœ¨ map ä¸­çš„ resolve æ–¹æ³•è¿”å›äº†å€¼ã€‚</li> <li>æœ€åä½¿ç”¨ sagas.forEach(sagaMiddleware.run) å¯åŠ¨äº† watcher çš„ç›‘å¬ã€‚</li></ol> <h3 id="store"><a href="#store" aria-hidden="true" class="header-anchor">#</a> store</h3> <p>ç°åœ¨å·²ç»æœ‰äº†é’ˆå¯¹å¼‚æ­¥æ•°æ®æµçš„è§£å†³åŠæ³•ï¼Œé‚£ä¹ˆè¯¥åˆ›å»º store äº†ã€‚</p> <p>æ­£å¸¸æƒ…å†µçš„ redux çš„ createStore æ¥æ”¶ä¸‰ä¸ªå‚æ•° reducer, initState,applyMiddleware(middlewares)ã€‚</p> <p>ä¸è¿‡ dva æä¾›äº†è‡ªå·±çš„ <code>createStore</code> æ–¹æ³•ï¼Œç”¨æ¥ç»„ç»‡ä¸€ç³»åˆ—è‡ªå·±åˆ›å»ºçš„å‚æ•°ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Create store</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> app<span class="token punctuation">.</span>_store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// eslint-disable-line</span>
      reducers<span class="token punctuation">:</span> <span class="token function">createReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      initialState<span class="token punctuation">:</span> hooksAndOpts<span class="token punctuation">.</span>initialState <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugin<span class="token punctuation">,</span>
      createOpts<span class="token punctuation">,</span>
      sagaMiddleware<span class="token punctuation">,</span>
      promiseMiddleware<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="createreducer"><a href="#createreducer" aria-hidden="true" class="header-anchor">#</a> createReducer</h4> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">function</span> <span class="token function">createReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reducerEnhancer</span><span class="token punctuation">(</span><span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>reducers<span class="token punctuation">,</span>
        <span class="token operator">...</span>extraReducers<span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_store <span class="token operator">?</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">.</span>asyncReducers <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>createReducer</code> å®é™…ä¸Šæ˜¯ç”¨ plugin é‡Œçš„ onReducer (å¦‚æœæœ‰)æ‰©å±•äº† reducer åŠŸèƒ½ï¼Œå¯¹äº <code>const reducerEnhancer = plugin.get('onReducer');</code>ï¼Œplugin é‡Œçš„ç›¸å…³ä»£ç ä¸ºï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getOnReducer</span><span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> reducerEnhancer <span class="token keyword">of</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reducer <span class="token operator">=</span> <span class="token function">reducerEnhancer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> reducer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>å¦‚æœæœ‰ onReducer çš„æ’ä»¶ï¼Œé‚£ä¹ˆç”¨ reducer çš„æ’ä»¶æ‰©å±• reducerï¼›å¦åˆ™ç›´æ¥è¿”å› reducerã€‚</p></blockquote> <p>combineReducers ä¸­ï¼š</p> <ul><li>ç¬¬ä¸€ä¸ª <code>...reducers</code> æ˜¯ä» dva é‡Œä¼ å…¥çš„ historyReducerï¼Œä»¥åŠé€šè¿‡ <code>reducers[m.namespace] = getReducer(m.reducers, m.state);</code> å‰¥ç¦»å‡ºçš„ model ä¸­çš„ reducer</li> <li>ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ‰‹åŠ¨åœ¨ plugin é‡Œæ·»åŠ çš„ extraReducersï¼›</li> <li>ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºå¼‚æ­¥ reducerï¼Œä¸»è¦æ˜¯ç”¨äºåœ¨ dva è¿è¡Œä»¥ååŠ¨æ€åŠ è½½ model é‡Œçš„ reducerã€‚</li></ul> <h4 id="createstore"><a href="#createstore" aria-hidden="true" class="header-anchor">#</a> createStore</h4> <p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª combine è¿‡çš„ reducerï¼Œæœ‰äº† core ä¸­åˆ›å»ºçš„ sagaMiddleware å’Œ promiseMiddlewareï¼Œè¿˜æœ‰äº†ä» dva ä¸­ä¼ å…¥çš„ createOptsï¼Œç°åœ¨å¯ä»¥æ­£å¼åˆ›å»º store äº†ã€‚</p> <blockquote><p>ä» dva ä¸­ä¼ å…¥çš„ createOpts ä¸º</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token function">setupMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>middlewares<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><blockquote><p>ç”¨ä¸æŠŠ redux-router çš„ä¸­é—´ä»¶æ’åœ¨ä¸­é—´ä»¶çš„ç¬¬ä¸€ä¸ªã€‚</p></blockquote> <p>è™½ç„¶çœ‹èµ·æ¥å¾ˆé•¿ï¼Œä½†æ˜¯å¯¹äºå¤§å¤šæ•°æ™®é€šç”¨æˆ·æ¥è¯´ï¼Œåœ¨æœªå¼€å¯ redux çš„è°ƒè¯•æ’ä»¶ï¼Œæœªä¼ å…¥é¢å¤–çš„ onAction ä»¥åŠ extraEnhancers çš„æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„ä»£ç ç­‰ä»·äº:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">,</span> compose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> flatten <span class="token keyword">from</span> <span class="token string">'flatten'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> invariant <span class="token keyword">from</span> <span class="token string">'invariant'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> window <span class="token keyword">from</span> <span class="token string">'global/window'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> returnSelf<span class="token punctuation">,</span> isArray <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  reducers<span class="token punctuation">,</span>
  initialState<span class="token punctuation">,</span>
  plugin<span class="token punctuation">,</span>
  sagaMiddleware<span class="token punctuation">,</span>
  promiseMiddleware<span class="token punctuation">,</span>
  createOpts<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    setupMiddlewares <span class="token operator">=</span> returnSelf<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">setupMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    sagaMiddleware<span class="token punctuation">,</span>
    promiseMiddleware
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> enhancers <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducers<span class="token punctuation">,</span> initialState<span class="token punctuation">,</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>enhancers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¯¹äº redux ä¸­ çš„ compose å‡½æ•°ï¼Œåœ¨æ•°ç»„é•¿åº¦ä¸º 1  çš„æƒ…å†µä¸‹è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</span>
  <span class="token comment">// compose(...enhancers) ç­‰åŒäº applyMiddleware(...middlewares)</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="è®¢é˜…"><a href="#è®¢é˜…" aria-hidden="true" class="header-anchor">#</a> è®¢é˜…</h3> <p>ç°åœ¨ dva å·²ç»åˆ›å»ºäº† storeï¼Œæœ‰äº†å¼‚æ­¥æ•°æ®æµåŠ è½½æ–¹æ¡ˆï¼Œå¹¶ä¸”åˆåšäº†ä¸€äº›å…¶ä»–çš„äº‹æƒ…ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Extend store</span>
    store<span class="token punctuation">.</span>runSaga <span class="token operator">=</span> sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">;</span>
    store<span class="token punctuation">.</span>asyncReducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute listeners when state is changed</span>
    <span class="token keyword">const</span> listeners <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'onStateChange'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> listener <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">listener</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Run sagas</span>
    sagas<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>æ‰‹åŠ¨è¿è¡Œ getSaga é‡Œè¿”å›çš„ watcer å‡½æ•°ã€‚</li> <li>åˆ¤æ–­å¦‚æœæœ‰ onStateChange çš„ plugin ä¹Ÿæ‰‹åŠ¨è¿è¡Œä¸€ä¸‹ã€‚</li></ul> <p>model é‡Œçš„ stateã€effectã€reducer å·²ç»å®ç°äº†ï¼Œå°±ç¼ºæœ€åçš„è®¢é˜… subscription éƒ¨åˆ†ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Setup app</span>
    <span class="token function">setupApp</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Run subscriptions</span>
    <span class="token keyword">const</span> unlisteners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">.</span>subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unlisteners<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">runSubscription</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>subscriptions<span class="token punctuation">,</span> model<span class="token punctuation">,</span> app<span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>setupApp(app) æ˜¯ä» dva é‡Œä¼ è¿‡æ¥çš„ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ patchHistory å‡½æ•°ä»£ç† history.linstenï¼Œå³å¼ºåŒ–äº† redux å’Œ router çš„è”ç³»ï¼Œæ˜¯çš„è·¯å¾„å˜åŒ–å¯ä»¥å¼•èµ· state çš„å˜åŒ–ï¼Œè¿›è€Œå¬è¿‡ç›‘å¬ state çš„å˜åŒ–æ¥è§¦å‘å›è°ƒã€‚</p> <blockquote><p>è¿™ä¹Ÿæ˜¯ core ä¸­å”¯ä¸€ä½¿ç”¨ this çš„åœ°æ–¹ï¼Œé€¼å¾— dva ä¸­å¿…é¡»ä½¿ç”¨ oldStart.call(app) æ¥è¿›è¡Œè°ƒç”¨ã€‚</p></blockquote> <h4 id="runsubscription"><a href="#runsubscription" aria-hidden="true" class="header-anchor">#</a> runSubscription</h4> <p>è¿™æ˜¯ runSubscription çš„ä»£ç </p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">subs<span class="token punctuation">,</span> model<span class="token punctuation">,</span> app<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> funcs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nonFuncs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> subs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>subs<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sub <span class="token operator">=</span> subs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> unlistener <span class="token operator">=</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        dispatch<span class="token punctuation">:</span> <span class="token function">prefixedDispatch</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">,</span>
        history<span class="token punctuation">:</span> app<span class="token punctuation">.</span>_history<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>unlistener<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        funcs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>unlistener<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        nonFuncs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> funcs<span class="token punctuation">,</span> nonFuncs <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ä¸º model ä¸­çš„ subscription å¯¹è±¡ã€‚</li> <li>ç¬¬äºŒä¸ªå‚æ•°ä¸ºå¯¹åº”çš„ model</li> <li>ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º core é‡Œåˆ›å»ºçš„ app</li> <li>ç¬¬å››ä¸ªå‚æ•°ä¸ºå…¨å±€å¼‚å¸¸æ•è·çš„ onError</li></ul> <ol><li><p><code>Object.prototype.hasOwnProperty.call(subs, key)</code>
è¿˜æ˜¯ä½¿ç”¨åŸå‹æ–¹æ³•åˆ¤æ–­ key æ˜¯ä¸æ˜¯ subs çš„è‡ªæœ‰å±æ€§ã€‚</p></li> <li><p>å¦‚æœæ˜¯è‡ªç”±å±æ€§ï¼Œé‚£ä¹ˆæ‹¿åˆ°å±æ€§å¯¹åº”çš„å€¼(æ˜¯ä¸€ä¸ª function)</p></li> <li><p>è°ƒç”¨è¯¥ functionï¼Œä¼ å…¥ dispatch å’Œ history å±æ€§ã€‚history å°±æ˜¯ç»è¿‡ redux-router å¼ºåŒ–è¿‡çš„ historyï¼Œè€Œ dispatchï¼Œä¹Ÿå°±æ˜¯ <code>prefixedDispatch(app._store.dispatch, model)</code></p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">prefixedDispatch</span><span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// æ–­è¨€æ£€æµ‹</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>action<span class="token punctuation">,</span> type<span class="token punctuation">:</span> <span class="token function">prefixType</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> model<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>å®é™…ä¸Šæ˜¯ç”¨å°† action é‡Œçš„ type æ·»åŠ äº† <code>${model.namespance}/</code> çš„å‰ç¼€ã€‚</p> <p>è‡ªæ­¤ï¼Œmodel ä¸­çš„å››å¤§ç»„ä»¶å…¨éƒ¨å®Œæ¯•ï¼Œå®Œæˆäº† dva çš„æ•°æ®å±‚å¤„ç†ã€‚</p></div> <div class="page-edit"><div class="edit-link"><a href="javascript:if(confirm('https://github.com/dvajs/dva/edit/master/docs/guide/source-code-explore.md  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='https://github.com/dvajs/dva/edit/master/docs/guide/source-code-explore.md'" tppabs="https://github.com/dvajs/dva/edit/master/docs/guide/source-code-explore.md" target="_blank" rel="noopener noreferrer">åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/26/2019, 9:45:19 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="develop-complex-spa.html" tppabs="https://dvajs.com/guide/develop-complex-spa.html" class="prev">
          ä½¿ç”¨ Dva å¼€å‘å¤æ‚ SPA
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="../assets/js/app.0350af5f.js" tppabs="https://dvajs.com/assets/js/app.0350af5f.js" defer></script><script src="../assets/js/15.d6e76d28.js" tppabs="https://dvajs.com/assets/js/15.d6e76d28.js" defer></script>
  </body>
</html>
